<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>消息API测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .tab { display: flex; margin-bottom: 20px; }
        .tab-item { padding: 10px 20px; background: #f0f0f0; cursor: pointer; margin-right: 10px; }
        .tab-item.active { background: #1890ff; color: white; }
        .message-list { border: 1px solid #ddd; }
        .message-item { padding: 15px; border-bottom: 1px solid #eee; }
        .message-title { font-weight: bold; margin-bottom: 5px; }
        .message-content { color: #666; margin-bottom: 5px; }
        .message-time { color: #999; font-size: 12px; }
        .badge { background: red; color: white; padding: 2px 6px; border-radius: 10px; font-size: 12px; }
        .error { color: red; }
        .loading { color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h1>消息中心API测试</h1>
        
        <div class="tab">
            <div class="tab-item active" onclick="switchTab('system')">系统通知 <span id="systemBadge" class="badge" style="display:none">0</span></div>
            <div class="tab-item" onclick="switchTab('order')">订单通知 <span id="orderBadge" class="badge" style="display:none">0</span></div>
        </div>
        
        <div id="messageList" class="message-list">
            <div class="loading">加载中...</div>
        </div>
        
        <div style="margin-top: 20px;">
            <button onclick="loadUnreadCount()">获取未读数量</button>
            <button onclick="loadMessages()">刷新消息</button>
        </div>
    </div>

    <script>
        let currentTab = 'system';
        const baseUrl = 'http://localhost:3000/api';
        
        // 模拟token（实际应用中应该从登录获取）
        const token = 'test_token';
        
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-item').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
            loadMessages();
        }
        
        async function loadMessages() {
            try {
                document.getElementById('messageList').innerHTML = '<div class="loading">加载中...</div>';
                
                const response = await fetch(`${baseUrl}/messages?type=${currentTab}&page=1&limit=10`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayMessages(result.data.messages);
                } else {
                    document.getElementById('messageList').innerHTML = `<div class="error">错误: ${result.message}</div>`;
                }
            } catch (error) {
                document.getElementById('messageList').innerHTML = `<div class="error">网络错误: ${error.message}</div>`;
            }
        }
        
        async function loadUnreadCount() {
            try {
                const response = await fetch(`${baseUrl}/messages/unread/count`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const systemBadge = document.getElementById('systemBadge');
                    const orderBadge = document.getElementById('orderBadge');
                    
                    if (result.data.system > 0) {
                        systemBadge.textContent = result.data.system;
                        systemBadge.style.display = 'inline';
                    } else {
                        systemBadge.style.display = 'none';
                    }
                    
                    if (result.data.order > 0) {
                        orderBadge.textContent = result.data.order;
                        orderBadge.style.display = 'inline';
                    } else {
                        orderBadge.style.display = 'none';
                    }
                } else {
                    console.error('获取未读数量失败:', result.message);
                }
            } catch (error) {
                console.error('网络错误:', error);
            }
        }
        
        function displayMessages(messages) {
            if (!messages || messages.length === 0) {
                document.getElementById('messageList').innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">暂无消息</div>';
                return;
            }
            
            const html = messages.map(msg => `
                <div class="message-item">
                    <div class="message-title">${msg.title} ${!msg.is_read ? '<span style="color: red; font-size: 12px;">[新]</span>' : ''}</div>
                    <div class="message-content">${msg.content}</div>
                    <div class="message-time">${formatTime(msg.created_at)}</div>
                </div>
            `).join('');
            
            document.getElementById('messageList').innerHTML = html;
        }
        
        function formatTime(timeStr) {
            const time = new Date(timeStr);
            const now = new Date();
            const diff = now - time;
            
            if (diff < 60 * 1000) {
                return '刚刚';
            } else if (diff < 60 * 60 * 1000) {
                return `${Math.floor(diff / (60 * 1000))}分钟前`;
            } else if (diff < 24 * 60 * 60 * 1000) {
                return `${Math.floor(diff / (60 * 60 * 1000))}小时前`;
            } else {
                return time.toLocaleDateString() + ' ' + time.toLocaleTimeString();
            }
        }
        
        // 页面加载时初始化
        window.onload = function() {
            loadMessages();
            loadUnreadCount();
        };
    </script>
</body>
</html>