<!--pages/order/detail/detail.wxml-->
<view class="container">
  <view wx:if="{{!loading && order}}" class="content-wrapper">
    <!-- è®¢å•çŠ¶æ€ -->
    <view class="status-section card">
 
      <view class="status-text">
        <text class="status-title">{{order.statusText}}</text>
        <text class="status-desc">{{order.statusDesc}}</text>
      </view>
    </view>

    <!-- è®¢å•åŸºæœ¬ä¿¡æ¯ -->
    <view class="section card">
      <view class="section-title">è®¢å•ä¿¡æ¯</view>
      <view class="info-row">
        <text class="label">è®¢å•å·ï¼š</text>
        <text class="value">{{order.orderNumber}}</text>
      </view>
      <view class="info-row">
        <text class="label">æœåŠ¡ç±»å‹ï¼š</text>
        <text class="value">{{order.serviceTypeName}}</text>
      </view>
      <view class="info-row">
        <text class="label">åˆ›å»ºæ—¶é—´ï¼š</text>
        <text class="value">{{order.createTime}}</text>
      </view>
      <view class="info-row" wx:if="{{order.amount}}">
        <text class="label">é¢„ä»˜æ¬¾ï¼š</text>
        <text class="value amount">Â¥{{order.amount || '30.00'}}</text>
      </view>
    </view>

    <!-- é—®é¢˜æè¿° -->
    <view class="section card">
      <view class="section-title">é—®é¢˜æè¿°</view>
      <view class="description">{{order.description}}</view>
      
      <!-- é—®é¢˜å›¾ç‰‡ -->
      <view class="images" wx:if="{{order.images && order.images.length > 0}}">
        <view class="image-title">é—®é¢˜å›¾ç‰‡ï¼š</view>
        <view class="image-list">
          <image 
            class="image-item"
            wx:for="{{order.images}}"
            wx:key="*this"
            src="{{item}}"
            mode="aspectFill"
            data-src="{{item}}"
            data-urls="{{order.images}}"
            bindtap="previewImage"
          ></image>
        </view>
      </view>
    </view>

    <!-- æœåŠ¡åœ°å€ -->
    <view class="section card">
      <view class="section-title">æœåŠ¡åœ°å€</view>
      <view class="address-info">
        <view class="contact-row">
          <text class="contact-name">{{order.contactName}}</text>
          <text class="contact-phone" bindtap="makePhoneCall" data-phone="{{order.contactPhone}}">{{order.contactPhone}}</text>
        </view>
        <view class="address-detail">{{order.address}}</view>
      </view>
    </view>

    <!-- ç”µå·¥ä¿¡æ¯ï¼ˆç”¨æˆ·è§†è§’ï¼‰ -->
    <view class="section card" wx:if="{{order.electrician && order.electrician.name}}">
      <view class="section-title">ç”µå·¥ä¿¡æ¯</view>
      <view class="electrician-info">
        <view class="electrician-avatar">
          <image src="{{order.electrician.avatar || '/images/default-avatar.png'}}" mode="aspectFill"></image>
        </view>
        <view class="electrician-details">
          <view class="electrician-name">{{order.electrician.name}}</view>
          <view class="electrician-phone" bindtap="makePhoneCall" data-phone="{{order.electrician.phone}}">{{order.electrician.phone}}</view>
          <view class="electrician-rating" wx:if="{{order.electrician.rating}}">
            <text>è¯„åˆ†ï¼š{{order.electrician.rating}}åˆ†</text>
          </view>
        </view>
      </view>
    </view>

    <!-- ç»´ä¿®é‡‘é¢ä¸å†…å®¹ï¼ˆå·²æ¥å•/å¾…æ”¯ä»˜ç»´ä¿®è´¹è§’è‰²è¾“å…¥ï¼‰ -->
    <view class="section card" wx:if="{{order.status === 'accepted' || order.status === 'pending_repair_payment'}}">
      <view class="section-title">ç»´ä¿®é‡‘é¢ä¸å†…å®¹</view>
      <block wx:if="{{order.canSubmitCompletedUpdate}}">
        <view class="update-form">
        <view class="form-item">
          <text class="form-label">ç»´ä¿®é‡‘é¢ï¼ˆå•ä½:å…ƒï¼‰</text>
          <input
            class="amount-input"
            placeholder="è¯·è¾“å…¥ç»´ä¿®é‡‘é¢"
            value="{{updateAmount}}"
            bindinput="onUpdateAmountInput"
            type="digit"
          />
          </view>
          <view class="form-item">
            <text class="form-label">ç»´ä¿®å†…å®¹ï¼š</text>
            <textarea
              class="work-content-input"
              placeholder="å¡«å†™ç»´ä¿®å†…å®¹"
              value="{{updateContent}}"
              bindinput="onUpdateContentInput"
              maxlength="500"
            ></textarea>
          </view>
        </view>
      </block>
      <block wx:else>
        <view class="form-item">
          <text class="form-label">ç»´ä¿®é‡‘é¢ï¼š</text>
          <text class="form-value">Â¥{{order.repairAmount || updateAmount || '0.00'}}</text>
        </view>
        <view class="form-item">
          <text class="form-label">ç»´ä¿®å†…å®¹ï¼š</text>
          <text class="form-value work-text">{{order.workContent || 'æš‚æ— ç»´ä¿®å†…å®¹'}}</text>
        </view>
      </block>
    </view>

    <!-- ç»´ä¿®å†…å®¹ï¼ˆè¿›è¡Œä¸­/å·²å®Œæˆ/å¾…æ”¯ä»˜çŠ¶æ€ï¼‰ -->
    <view class="section card" wx:elif="{{order.status === 'in_progress' || order.status === 'pending_payment' || order.status === 'completed'}}">
      <view class="section-title">ç»´ä¿®å†…å®¹</view>
      <view class="description">{{order.description}}</view>

      <!-- ç”µå·¥å¡«å†™ç»´ä¿®å†…å®¹ -->
      <view wx:if="{{action === 'complete'}}" class="work-form">
        <view class="form-item">
          <text class="form-label">ç»´ä¿®å†…å®¹ï¼š</text>
          <textarea 
            class="work-content-input"
            placeholder="è¯·è¯¦ç»†æè¿°ç»´ä¿®è¿‡ç¨‹å’Œç»“æœ"
            value="{{workContent}}"
            bindinput="onWorkContentInput"
            maxlength="500"
          ></textarea>
        </view>
        
        <view class="form-item">
          <text class="form-label">ç»´ä¿®å›¾ç‰‡ï¼š</text>
          <view class="work-images">
            <view 
              class="work-image-item"
              wx:for="{{workImages}}"
              wx:key="*this"
            >
              <image src="{{item}}" mode="aspectFill"></image>
              <view class="delete-btn" data-index="{{index}}" bindtap="deleteWorkImage">Ã—</view>
            </view>
            <view 
              class="add-work-image-btn"
              wx:if="{{workImages.length < 3}}"
              bindtap="chooseWorkImage"
            >
              <text class="add-icon">+</text>
            </view>
          </view>
        </view>
        
        <view class="form-item">
          <text class="form-label">ç»´ä¿®é‡‘é¢ï¼š</text>
          <input 
            class="amount-input"
            placeholder="è¯·è¾“å…¥ç»´ä¿®é‡‘é¢"
            value="{{finalAmount}}"
            bindinput="onFinalAmountInput"
            type="digit"
          />
          <text class="amount-unit">å…ƒ</text>
        </view>
      </view>
      
      <!-- æ˜¾ç¤ºå·²å¡«å†™çš„ç»´ä¿®å†…å®¹ -->
      <view wx:else>
        <view class="work-content" wx:if="{{order.workContent}}">
          <text class="work-text">{{order.workContent}}</text>
        </view>
        
        <!-- ç»´ä¿®å›¾ç‰‡ -->
        <view class="work-images-display" wx:if="{{order.workImages && order.workImages.length > 0}}">
          <view class="image-title">ç»´ä¿®å›¾ç‰‡ï¼š</view>
          <view class="image-list">
            <image 
              class="image-item"
              wx:for="{{order.workImages}}"
              wx:key="*this"
              src="{{item}}"
              mode="aspectFill"
              data-src="{{item}}"
              data-urls="{{order.workImages}}"
              bindtap="previewImage"
            ></image>
          </view>
        </view>
        
        <view wx:if="{{!order.workContent}}" class="no-work-content">
          <text>ç”µå·¥æš‚æœªå¡«å†™ç»´ä¿®å†…å®¹</text>
        </view>
      </view>
    </view>

    <!-- è®¢å•æ—¶é—´çº¿ -->
    <view class="section card" wx:if="{{order.timeline && order.timeline.length > 0}}">
      <view class="section-title">è®¢å•è¿›åº¦</view>
      <view class="timeline">
        <view 
          class="timeline-item"
          wx:for="{{order.timeline}}"
          wx:key="id"
        >
          <view class="timeline-dot"></view>
          <view class="timeline-content">
            <view class="timeline-title">{{item.title}}</view>
            <view class="timeline-time">{{item.time}}</view>
          </view>
        </view>
      </view>
    </view>

  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-bar" wx:if="{{!loading && order}}">
  <view class="bottom-content">
    <!-- å·¦ä¾§å®¢æœæŒ‰é’® -->
    <button class="service-btn" open-type="contact">
      <text class="service-text">å®¢æœ</text>
    </button>
    
    <!-- å³ä¾§æ“ä½œæŒ‰é’®åŒºåŸŸ -->
    <view class="action-area">
      <!-- å¾…æ¥å•çŠ¶æ€ -->
      <block wx:if="{{order.status === 'pending'}}">
        <button 
          wx:if="{{order.canAccept}}"
          class="main-action-btn primary"
          bindtap="acceptOrder"
        >
          æ¥å•
        </button>
      </block>

      <!-- è¿›è¡Œä¸­çŠ¶æ€ -->
      <block wx:if="{{order.status === 'in_progress'}}">
        <button 
          wx:if="{{order.canComplete && action === 'complete'}}"
          class="main-action-btn primary {{completing ? 'disabled' : ''}}"
          bindtap="completeOrder"
          disabled="{{completing}}"
        >
          {{completing ? 'æäº¤ä¸­...' : 'å®Œæˆè®¢å•'}}
        </button>
        <button 
          wx:elif="{{order.electrician && order.electrician.phone}}"
          class="main-action-btn secondary"
          data-phone="{{order.electrician.phone}}"
          bindtap="makePhoneCall"
        >
          è”ç³»ç”µå·¥
        </button>
      </block>

      <!-- å¾…æ”¯ä»˜çŠ¶æ€ -->
      <block wx:if="{{order.status === 'pending_payment'}}">
        <button 
          wx:if="{{order.canPay}}"
          class="main-action-btn pay"
          bindtap="goToPay"
        >
          å»æ”¯ä»˜Â¥{{order.amount || '30.00'}}
        </button>
      </block>

      <!-- å¾…æ”¯ä»˜ç»´ä¿®è´¹çŠ¶æ€ -->
      <block wx:if="{{order.status === 'pending_repair_payment'}}">
        <button
          wx:if="{{order.canPayRepairFee}}"
          class="main-action-btn pay"
          bindtap="goToRepairPay"
          disabled="{{paying}}"
        >
          {{paying ? 'æ”¯ä»˜ä¸­...' : 'æ”¯ä»˜ç»´ä¿®è´¹Â¥' + (order.repairAmount || updateAmount || '0.00')}}
        </button>
        <button
          wx:if="{{order.canSubmitCompletedUpdate}}"
          class="main-action-btn primary {{updating ? 'disabled' : ''}}"
          bindtap="submitUpdate"
          disabled="{{updating}}"
        >
          {{updating ? 'æäº¤ä¸­...' : 'æäº¤ç»´ä¿®ä¿¡æ¯'}}
        </button>
      </block>

      <!-- å·²æ¥å•çŠ¶æ€ï¼ˆç”µå·¥å¡«å†™é‡‘é¢/å†…å®¹åæäº¤ï¼‰ -->
      <block wx:if="{{order.status === 'accepted'}}">
        <button
          wx:if="{{order.canSubmitCompletedUpdate}}"
          class="main-action-btn primary {{updating ? 'disabled' : ''}}"
          bindtap="submitUpdate"
          disabled="{{updating}}"
        >
          {{updating ? 'æäº¤ä¸­...' : 'æäº¤ç»´ä¿®ä¿¡æ¯'}}
        </button>
      </block>

      <!-- å·²å®ŒæˆçŠ¶æ€ -->
      <block wx:if="{{order.status === 'completed'}}">
        <button 
          wx:if="{{order.canReview}}"
          class="main-action-btn primary"
          bindtap="goToReview"
        >
          è¯„ä»·
        </button>
        <button
          wx:elif="{{order.canSubmitCompletedUpdate}}"
          class="main-action-btn primary {{updating ? 'disabled' : ''}}"
          bindtap="submitUpdate"
          disabled="{{updating}}"
        >
          {{updating ? 'æäº¤ä¸­...' : 'æäº¤'}}
        </button>
      </block>
    </view>
  </view>
  </view>

  <!-- è®¢å•ä¸å­˜åœ¨ -->
  <view wx:if="{{!loading && !order}}" class="empty-state">
    <text class="empty-icon">ğŸ“‹</text>
    <text class="empty-text">è®¢å•ä¸å­˜åœ¨</text>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading}}">
    <text>åŠ è½½ä¸­...</text>
  </view>
</view>