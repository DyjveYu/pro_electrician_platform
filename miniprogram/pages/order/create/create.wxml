<view class="page-container">
  <!-- 服务类型 -->
  <view class="form-section">
    <view class="section-title">选择服务类型</view>
    <view class="service-list">
      <block wx:for="{{serviceTypes}}" wx:key="id">
        <view class="service-item {{selectedServiceType && selectedServiceType.id === item.id ? 'active' : ''}}" 
              data-index="{{index}}" 
              bindtap="selectServiceType">
          <text>{{item.name}}</text>
        </view>
      </block>
    </view>
  </view>

  <!-- 问题描述 -->
  <view class="form-section">
    <view class="section-title">故障描述</view>
    <textarea placeholder="请描述您遇到的问题..." 
              value="{{description}}" 
              bindinput="onDescriptionInput" 
              maxlength="220"
              class="desc-textarea"/>
  </view>

  <!-- 上传图片 -->
  <view class="form-section">
    <view class="section-title">上传图片（选填）</view>
    <view class="image-list">
      <block wx:for="{{images}}" wx:key="index">
        <image src="{{item}}" class="uploaded-image" mode="aspectFill" />
      </block>
      <view class="add-image" bindtap="chooseImage">+</view>
    </view>
  </view>

  <!-- 服务地址与时间 -->
  <view class="form-section">
    <view class="section-title">服务地址与时间</view>
    <view class="form-item" bindtap="openAddressSheet">
      <text class="label">请选择上门地址</text>
      <view class="value">
        <text wx:if="{{selectedAddressStr}}">{{selectedAddressStr}}</text>
        <text wx:else class="placeholder">点击选择地址</text>
      </view>
    </view>
    <view class="form-item" bindtap="openTimeSheet">
      <text class="label">请选择上门时间</text>
      <view class="value">
        <text wx:if="{{expectedTimeStr}}">{{expectedTimeStr}}</text>
        <text wx:else class="placeholder">点击选择时间</text>
      </view>
    </view>
  </view>

  <!-- 底部提交预约条 -->
  <view class="submit-bar">
    <view class="prepay-text">预付 ￥{{prepayAmount}}</view>
    <button class="booking-btn" bindtap="submitOrder" loading="{{submitting}}" disabled="{{!canSubmit}}">
      {{submitting ? '正在创建订单' : '立即下单预约'}}
    </button>
  </view>

  <!-- 地址选择弹层 -->
  <view wx:if="{{showAddressSheet}}" class="sheet-mask" bindtap="closeAddressSheet"></view>
  <view wx:if="{{showAddressSheet}}" class="action-sheet" catchtouchmove="true">
    <view class="sheet-header">
      <text>选择服务地址</text>
      <view class="close-icon" bindtap="closeAddressSheet">×</view>
    </view>
    <scroll-view scroll-y="true" class="sheet-body">
      <view class="address-item" wx:for="{{addresses}}" wx:key="id" bindtap="selectAddress" data-address="{{item}}">
        <view class="address-main">
          <text class="addr-title">{{item.contactName}} {{item.contactPhone}}</text>
          <text class="addr-detail">{{item.province}}{{item.city}}{{item.district}}{{item.detail}}</text>
        </view>
        <view class="addr-actions">
          <button class="mini-btn" data-id="{{item.id}}" bindtap="editAddress" catchtap="editAddress">编辑</button>
        </view>
      </view>
      <view class="empty-tip" wx:if="{{!loadingAddresses && addresses.length === 0}}">暂无地址，请新增</view>
    </scroll-view>
    <view class="sheet-footer">
      <button class="footer-btn secondary" bindtap="openMapChoose" data-type="map">从地图选择</button>
      <button class="footer-btn primary" bindtap="addAddress">新增地址</button>
    </view>
  </view>

  <!-- 时间选择弹层 -->
  <view wx:if="{{showTimeSheet}}" class="sheet-mask" bindtap="closeTimeSheet"></view>
  <view wx:if="{{showTimeSheet}}" class="action-sheet" catchtouchmove="true">
    <view class="sheet-header">
      <text>您期望上门服务时间</text>
      <view class="close-icon" bindtap="closeTimeSheet">×</view>
    </view>
    <view class="time-sheet-body">
      <scroll-view scroll-y="true" class="date-column">
        <view class="date-item {{selectedDateIndex === index ? 'selected' : ''}}" 
              wx:for="{{dateList}}" wx:key="index" 
              data-index="{{index}}" bindtap="selectDate">
          <text>{{item.label}}</text>
        </view>
      </scroll-view>
      <scroll-view scroll-y="true" class="slot-column">
        <view class="slot-item {{selectedSlot === item ? 'selected' : ''}}" 
              wx:for="{{timeSlots}}" wx:key="item" 
              data-slot="{{item}}" bindtap="selectSlot">
          <text>{{item}}</text>
        </view>
      </scroll-view>
    </view>
    <view class="sheet-footer">
      <button class="footer-btn primary" bindtap="confirmTime">确定</button>
    </view>
  </view>
</view>
