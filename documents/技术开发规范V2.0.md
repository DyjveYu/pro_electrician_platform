# 电工维修平台 - 完整技术规范文档 v2.0.4

> **版本**: v1.0  
> **更新日期**: 2025-10-08  
> **适用范围**: 后端API开发、AI辅助开发、团队协作

---

## 📋 快速导航

- [1. 核心原则](#1-核心原则)
- [2. 技术栈](#2-技术栈)
- [3. 数据库操作](#3-数据库操作)
- [4. API开发](#4-api开发)
- [5. 错误处理](#5-错误处理)
- [6. 安全认证](#6-安全认证)
- [7. 文件上传](#7-文件上传)
- [8. 代码结构](#8-代码结构)
- [9. AI协作规范](#9-ai协作规范)
- [10. 问题对照表](#10-问题对照表)

---

## 1. 核心原则

### 1.1 铁律（必须遵守）⚠️

```
✅ 必须
• 使用 Sequelize ORM 进行所有数据库操作
• 使用统一响应格式 res.success/res.error/res.paginate
• 使用 Joi 进行所有参数验证
• 使用 async/await（禁止回调函数）
• 通过 next(error) 传递错误到统一中间件
• 使用 AppError 类抛出业务错误

❌ 禁止
• 手写原始SQL（除非性能优化需求且有注释）
• 使用数组传递参数（除列表数据）
• 直接使用 res.json() 返回响应
• 在控制器中 return res.error()
• 在 try-catch 中返回错误响应
• 混用数组解构 [rows] 和 rows[0]
```

### 1.2 代码质量标准

| 维度 | 标准 | 检查方法 |
|-----|-----|---------|
| **可读性** | 清晰命名、必要注释 | 变量名见名知意 |
| **可维护性** | 模块化、职责单一 | 函数不超过50行 |
| **安全性** | 验证、防注入、认证 | 所有接口有验证 |
| **一致性** | 统一规范和格式 | 响应格式一致 |
| **性能** | 合理查询、使用索引 | 避免N+1查询 |

---

## 2. 技术栈

### 2.1 核心技术

```javascript
{
  "runtime": "Node.js 18+",
  "framework": "Express.js 4.x",
  "orm": "Sequelize 6.x",        // ⭐ 必须使用
  "database": "MySQL 8.0",
  "cache": "Redis 6.x",
  "auth": "JWT + bcryptjs",
  "validation": "Joi",
  "upload": "multer",            // 本地存储
  "logging": "Winston"
}
```

### 2.2 必装依赖

```bash
# 核心
npm install sequelize mysql2
npm install joi
npm install jsonwebtoken bcryptjs
npm install redis winston

# 文件上传
npm install multer

# 工具
npm install dotenv helmet cors morgan express-rate-limit
```

### 2.3 环境变量

```env
# .env 示例

# 应用
NODE_ENV=development
PORT=3000

# 数据库
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=electrician_platform

# JWT
JWT_SECRET=your_secret_key_min_32_chars
JWT_EXPIRES_IN=7d

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379

# 上传
UPLOAD_DIR=./uploads
MAX_FILE_SIZE=10485760

# 短信（测试模式）
SMS_TEST_MODE=true
SMS_CODE_EXPIRES_IN=120

# 支付
PAYMENT_TEST_MODE=true
```

---

## 3. 数据库操作

### 3.1 Sequelize配置

```javascript
// config/sequelize.js
const { Sequelize } = require('sequelize');
require('dotenv').config();

const sequelize = new Sequelize(
  process.env.DB_NAME,
  process.env.DB_USER,
  process.env.DB_PASSWORD,
  {
    host: process.env.DB_HOST,
    port: process.env.DB_PORT || 3306,
    dialect: 'mysql',
    
    pool: {
      max: 10,
      min: 0,
      acquire: 30000,
      idle: 10000
    },
    
    logging: process.env.NODE_ENV === 'development' ? console.log : false,
    timezone: '+08:00',
    
    define: {
      underscored: true,      // 驼峰转下划线
      freezeTableName: true,  // 禁止表名复数化
      timestamps: true,
      createdAt: 'created_at',
      updatedAt: 'updated_at'
    }
  }
);

sequelize.authenticate()
  .then(() => console.log('✅ 数据库连接成功'))
  .catch(err => {
    console.error('❌ 数据库连接失败:', err);
    process.exit(1);
  });

module.exports = sequelize;
```

### 3.2 模型定义模板

```javascript
// models/ElectricianCertification.js
const { DataTypes } = require('sequelize');
const sequelize = require('../config/sequelize');

const ElectricianCertification = sequelize.define('ElectricianCertification', {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true,
    comment: '认证ID'
  },
  
  user_id: {
    type: DataTypes.INTEGER,
    allowNull: false,
    comment: '用户ID'
  },
  
  real_name: {
    type: DataTypes.STRING(50),
    allowNull: false,
    comment: '真实姓名',
    validate: {
      len: [2, 50]
    }
  },
  
  id_card: {
    type: DataTypes.STRING(18),
    allowNull: false,
    comment: '身份证号',
    validate: {
      is: /^[1-9]\d{5}(18|19|20)\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])\d{3}[\dXx]$/
    }
  },
  
  electrician_cert_no: {
    type: DataTypes.STRING(50),
    allowNull: false,
    comment: '电工证编号'
  },
  
  cert_start_date: {
    type: DataTypes.DATEONLY,
    allowNull: false,
    comment: '证书开始日期'
  },
  
  cert_end_date: {
    type: DataTypes.DATEONLY,
    allowNull: false,
    comment: '证书结束日期'
  },
  
  status: {
    type: DataTypes.ENUM('pending', 'approved', 'rejected'),
    defaultValue: 'pending',
    comment: '认证状态'
  },
  
  reject_reason: {
    type: DataTypes.TEXT,
    allowNull: true,
    comment: '驳回原因'
  }
  
}, {
  tableName: 'electrician_certifications',
  timestamps: true,
  indexes: [
    { fields: ['user_id'] },
    { fields: ['status'] }
  ]
});

module.exports = ElectricianCertification;
```

### 3.3 错误 vs 正确

#### ❌ 错误示例（当前代码问题）

```javascript
// 问题1: 直接使用 pool.query
const checkResult = await pool.query(
  'SELECT * FROM electrician_certifications WHERE user_id = ?',
  [user_id]
);

// 问题2: 手写SQL
const query = `INSERT INTO electrician_certifications 
               (user_id, real_name) VALUES (?, ?)`;
await pool.query(query, [user_id, real_name]);

// 问题3: 数组解构混乱
if (checkResult[0].length > 0) { ... }  // 有时用 [0]
const [rows] = await pool.query(...);   // 有时用解构
```

#### ✅ 正确示例

```javascript
const { ElectricianCertification } = require('../models');

// 查询
const cert = await ElectricianCertification.findOne({
  where: { user_id: userId }
});

// 创建
const newCert = await ElectricianCertification.create({
  user_id: userId,
  real_name: realName,
  id_card: idCard
});

// 更新
await cert.update({
  real_name: realName,
  status: 'pending'
});

// 删除
await ElectricianCertification.destroy({
  where: { id: certId }
});
```

### 3.4 常用查询

```javascript
const { Op } = require('sequelize');

// 1. 基础查询
const user = await User.findOne({ where: { phone } });
const user = await User.findByPk(userId);

// 2. 条件查询
const orders = await Order.findAll({
  where: {
    status: { [Op.in]: ['pending', 'accepted'] },
    created_at: { [Op.gte]: new Date('2025-01-01') }
  }
});

// 3. 关联查询
const order = await Order.findByPk(orderId, {
  include: [
    { model: User, as: 'user', attributes: ['id', 'nickname'] },
    { model: User, as: 'electrician' }
  ]
});

// 4. 分页
const { count, rows } = await Order.findAndCountAll({
  where: { user_id: userId },
  limit: 20,
  offset: (page - 1) * 20,
  order: [['created_at', 'DESC']]
});

// 5. 聚合
const stats = await Order.findOne({
  where: { user_id: userId },
  attributes: [
    [sequelize.fn('COUNT', sequelize.col('id')), 'total'],
    [sequelize.fn('SUM', sequelize.col('final_amount')), 'sum']
  ],
  raw: true
});

// 6. 事务
const result = await sequelize.transaction(async (t) => {
  const order = await Order.create({ ... }, { transaction: t });
  await User.increment('count', { where: { id }, transaction: t });
  return order;
});
```

---

## 4. API开发

### 4.1 统一响应格式

```javascript
// middleware/responseFormatter.js
module.exports = (req, res, next) => {
  res.success = (data = {}, message = '操作成功') => {
    res.json({
      code: 200,
      message,
      data,
      timestamp: Date.now()
    });
  };

  res.error = (message = '操作失败', code = 500, data = {}) => {
    res.status(code).json({
      code,
      message,
      data,
      timestamp: Date.now()
    });
  };

  res.paginate = (list = [], total = 0, page = 1, limit = 10, message = '操作成功') => {
    res.json({
      code: 200,
      message,
      data: {
        list,
        total,
        page: parseInt(page),
        limit: parseInt(limit),
        pages: Math.ceil(total / limit)
      },
      timestamp: Date.now()
    });
  };

  next();
};
```

### 4.2 参数验证

```javascript
// schemas/electricianSchemas.js
const Joi = require('joi');

const schemas = {
  electricianCertification: Joi.object({
    real_name: Joi.string().min(2).max(50).required()
      .messages({ 'any.required': '真实姓名不能为空' }),
      
    id_card: Joi.string()
      .pattern(/^[1-9]\d{5}(18|19|20)\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])\d{3}[\dXx]$/)
      .required()
      .messages({ 'string.pattern.base': '身份证号格式不正确' }),
      
    electrician_cert_no: Joi.string().required(),
    cert_start_date: Joi.date().required(),
    cert_end_date: Joi.date().greater(Joi.ref('cert_start_date')).required()
      .messages({ 'date.greater': '结束日期必须大于开始日期' })
  })
};

module.exports = schemas;
```

```javascript
// middleware/validation.js
const validate = (schema) => {
  return (req, res, next) => {
    const { error, value } = schema.validate(req.body, {
      abortEarly: false,
      stripUnknown: true
    });

    if (error) {
      const messages = error.details.map(d => d.message).join('; ');
      return res.error(messages, 422);
    }

    req.body = value;
    next();
  };
};

module.exports = { validate };
```

### 4.3 控制器模板

```javascript
// controllers/electricianController.js
const { ElectricianCertification } = require('../models');
const AppError = require('../utils/AppError');

class ElectricianController {
  /**
   * 提交电工认证
   * @route POST /api/electricians/certification
   * @access Private
   */
  static async submitCertification(req, res, next) {
    try {
      const userId = req.user.id;
      const {
        real_name,
        id_card,
        electrician_cert_no,
        cert_start_date,
        cert_end_date
      } = req.body;

      // 检查现有记录
      const existing = await ElectricianCertification.findOne({
        where: { user_id: userId }
      });

      let certification;

      if (existing) {
        // 更新
        await existing.update({
          real_name,
          id_card,
          electrician_cert_no,
          cert_start_date,
          cert_end_date,
          status: 'pending',
          reject_reason: null
        });
        certification = existing;
      } else {
        // 创建
        certification = await ElectricianCertification.create({
          user_id: userId,
          real_name,
          id_card,
          electrician_cert_no,
          cert_start_date,
          cert_end_date,
          status: 'pending'
        });
      }

      res.success({
        certification: {
          id: certification.id,
          status: certification.status
        }
      }, '认证申请提交成功，等待审核');

    } catch (error) {
      next(error);
    }
  }

  /**
   * 获取认证状态
   */
  static async getCertificationStatus(req, res, next) {
    try {
      const userId = req.user.id;

      const cert = await ElectricianCertification.findOne({
        where: { user_id: userId }
      });

      if (!cert) {
        return res.success({
          status: 'not_submitted',
          message: '未提交认证',
          certification: null
        });
      }

      const messages = {
        pending: '认证审核中',
        approved: '认证已通过',
        rejected: `认证被拒绝：${cert.reject_reason || '无原因'}`
      };

      res.success({
        status: cert.status,
        message: messages[cert.status],
        certification: cert
      });

    } catch (error) {
      next(error);
    }
  }
}

module.exports = ElectricianController;
```

### 4.4 路由定义

```javascript
// routes/electricians.js
const express = require('express');
const router = express.Router();
const ElectricianController = require('../controllers/electricianController');
const { authenticateToken } = require('../middleware/auth');
const { validate } = require('../middleware/validation');
const schemas = require('../schemas/electricianSchemas');
const rateLimiter = require('../middleware/rateLimiter');

/**
 * @route POST /api/electricians/certification
 * @desc 提交电工认证
 * @access Private
 */
router.post('/certification',
  authenticateToken,
  rateLimiter({ max: 5, windowMs: 60000 }),
  validate(schemas.electricianCertification),
  ElectricianController.submitCertification
);

/**
 * @route GET /api/electricians/certification/status
 * @desc 获取认证状态
 * @access Private
 */
router.get('/certification/status',
  authenticateToken,
  ElectricianController.getCertificationStatus
);

module.exports = router;
```

---

## 5. 错误处理

### 5.1 自定义错误类

```javascript
// utils/AppError.js
class AppError extends Error {
  constructor(message, statusCode = 400, data = {}) {
    super(message);
    this.statusCode = statusCode;
    this.data = data;
    this.isOperational = true;
    Error.captureStackTrace(this, this.constructor);
  }
}

module.exports = AppError;
```

### 5.2 统一错误处理

```javascript
// middleware/errorHandler.js
module.exports = (err, req, res, next) => {
  console.error('Error:', err);

  // Joi验证错误
  if (err.isJoi) {
    return res.error(err.details[0].message, 422);
  }

  // JWT错误
  if (err.name === 'JsonWebTokenError') {
    return res.error('无效的token', 401);
  }
  if (err.name === 'TokenExpiredError') {
    return res.error('token已过期', 401);
  }

  // Sequelize错误
  if (err.name === 'SequelizeUniqueConstraintError') {
    return res.error('数据已存在', 409);
  }
  if (err.name === 'SequelizeValidationError') {
    const msg = err.errors.map(e => e.message).join('; ');
    return res.error(msg, 422);
  }

  // 业务错误
  if (err.isOperational) {
    return res.error(err.message, err.statusCode, err.data);
  }

  // 默认错误
  res.error('服务器内部错误', 500);
};
```

### 5.3 使用方式

```javascript
// 抛出错误
if (!user) {
  throw new AppError('用户不存在', 404);
}

if (user.status === 'banned') {
  throw new AppError('账号已被禁用', 403);
}
```

---

## 6. 安全认证

### 6.1 JWT认证

```javascript
// middleware/auth.js
const jwt = require('jsonwebtoken');
const { User } = require('../models');
const AppError = require('../utils/AppError');
const redis = require('../config/redis');

const authenticateToken = async (req, res, next) => {
  try {
    const authHeader = req.headers.authorization;
    const token = authHeader && authHeader.replace('Bearer ', '');

    if (!token) {
      throw new AppError('未提供token', 401);
    }

    // 检查黑名单
    const isBlacklisted = await redis.get(`blacklist:${token}`);
    if (isBlacklisted) {
      throw new AppError('token已失效', 401);
    }

    // 验证
    const decoded = jwt.verify(token, process.env.JWT_SECRET);

    const user = await User.findByPk(decoded.id);
    if (!user || user.status === 'banned') {
      throw new AppError('用户不存在或已禁用', 401);
    }

    req.user = {
      id: user.id,
      phone: user.phone,
      current_role: user.current_role
    };

    next();
  } catch (error) {
    next(error);
  }
};

module.exports = { authenticateToken };
```

### 6.2 短信验证码（测试）

```javascript
// utils/smsService.js
const redis = require('../config/redis');

class SmsService {
  static validatePhone(phone) {
    return /^1[3-9]\d{9}$/.test(phone);
  }

  static async sendVerificationCode(phone, type = 'login') {
    const code = process.env.SMS_TEST_MODE === 'true' 
      ? '123456' 
      : Math.random().toString().slice(2, 8);

    await redis.setex(`sms:${type}:${phone}`, 120, code);

    console.log(`📱 验证码: ${phone} -> ${code}`);

    return {
      success: true,
      message: '验证码已发送',
      code: process.env.NODE_ENV !== 'production' ? code : undefined
    };
  }

  static async verifyCode(phone, code, type = 'login') {
    const key = `sms:${type}:${phone}`;
    const stored = await redis.get(key);

    if (!stored) return { success: false, message: '验证码已过期' };
    if (stored !== code) return { success: false, message: '验证码错误' };

    await redis.del(key);
    return { success: true };
  }
}

module.exports = SmsService;
```
### 6.3 频率限制
```javascript
javascript// middleware/rateLimiter.js
const rateLimit = require('express-rate-limit');

const rateLimiter = (options = {}) => {
  return rateLimit({
    windowMs: options.windowMs || 60 * 1000,
    max: options.max || 10,
    message: '请求过于频繁，请稍后再试',
    standardHeaders: true
  });
};

module.exports = rateLimiter;
```
---

## 7. 文件上传

### 7.1 Multer配置

```javascript
// middleware/upload.js
const multer = require('multer');
const path = require('path');
const fs = require('fs');
const AppError = require('../utils/AppError');

const uploadDir = process.env.UPLOAD_DIR || './uploads';

const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    const subDirs = {
      'avatar': 'avatars',
      'cert_images': 'certifications',
      'problem_images': 'problems',
      'repair_images': 'repairs'
    };
    
    const subDir = subDirs[file.fieldname] || 'others';
    const fullPath = path.join(uploadDir, subDir);
    
    if (!fs.existsSync(fullPath)) {
      fs.mkdirSync(fullPath, { recursive: true });
    }

    cb(null, fullPath);
  },
  
  filename: (req, file, cb) => {
    const unique = Date.now() + '-' + Math.round(Math.random() * 1E9);
    const ext = path.extname(file.originalname);
    cb(null, `${file.fieldname}-${unique}${ext}`);
  }
});

const fileFilter = (req, file, cb) => {
  const allowed = ['image/jpeg', 'image/png', 'image/jpg'];
  if (allowed.includes(file.mimetype)) {
    cb(null, true);
  } else {
    cb(new AppError('只支持JPG/PNG', 400), false);
  }
};

const upload = multer({
  storage,
  fileFilter,
  limits: { fileSize: 10 * 1024 * 1024 }
});

module.exports = {
  uploadSingle: (field) => upload.single(field),
  uploadMultiple: (field, max = 5) => upload.array(field, max)
};
```

---

## 8. 代码结构

### 8.1 完整目录

```
backend/
├── src/
│   ├── app.js
│   ├── config/
│   │   ├── database.js        # 原配置（保留）
│   │   ├── sequelize.js       # ⭐ 新增
│   │   └── redis.js
│   ├── models/                # ⭐ 新增
│   │   ├── index.js
│   │   ├── User.js
│   │   ├── Order.js
│   │   ├── Electrician.js
│   │   ├── ElectricianCertification.js
│   │   ├── Address.js
│   │   ├── Message.js
│   │   ├── Payment.js
│   │   ├── Review.js
│   │   ├── ServiceType.js
│   │   └── SystemMessage.js
│   ├── controllers/
│   ├── routes/
│   ├── middleware/
│   │   ├── auth.js
│   │   ├── validation.js
│   │   ├── responseFormatter.js
│   │   ├── errorHandler.js
│   │   ├── rateLimiter.js
│   │   └── upload.js
│   ├── schemas/               # ⭐ 新增
│   │   ├── userSchemas.js
│   │   ├── electricianSchemas.js
│   │   └── ...
│   ├── services/
│   │   └── smsService.js
│   ├── utils/
│   │   ├── AppError.js        # ⭐ 新增
│   │   └── logger.js
│   └── tests/
├── uploads/
├── .env
├── .env.example
├── package.json
└── server.js
```

---

## 9. AI协作规范

### 9.1 重构接口标准Prompt

````
# 重构任务

## 当前代码
```javascript
[粘贴现有接口代码]
```

## 重构要求
1. 使用 Sequelize ORM 替换所有原始SQL
2. 使用 Joi 进行参数验证
3. 使用 async/await
4. 使用 res.success/res.error 统一响应
5. 使用 AppError 抛出业务错误
6. 通过 next(error) 传递错误
7. 添加完整注释

## 参考规范

### AppError类
```javascript
class AppError extends Error {
  constructor(message, statusCode = 400, data = {}) {
    super(message);
    this.statusCode = statusCode;
    this.data = data;
    this.isOperational = true;
  }
}
```

### 响应格式
- 成功: res.success(data, message)
- 错误: throw new AppError(message, statusCode)

### Sequelize模型
```javascript
[粘贴相关模型定义]
```

## 输出要求
1. 完整控制器代码
2. Joi验证Schema
3. 路由定义
4. 关键改动说明

请开始重构。
````

### 9.2 重构检查清单

每个接口完成后检查：

```
□ 使用Sequelize，无原始SQL
□ 使用Joi验证所有参数
□ 使用res.success/error统一响应
□ 使用AppError抛出错误
□ 通过next(error)传递错误
□ 添加路由注释
□ 测试正常情况
□ 测试异常情况
□ 响应格式符合规范
```

---

## 10. 问题对照表

| 问题 | 原因 | 解决方案 |
|-----|------|---------|
| SQL注入风险 | 手写SQL | 使用Sequelize |
| 响应格式不统一 | 直接res.json() | 使用res.success/error |
| 错误处理混乱 | 各自处理 | AppError + errorHandler |
| 缺少参数验证 | 未验证 | Joi schemas |
| 数组解构错误 | [rows]混用 | 统一Sequelize格式 |
| 数据库字段不一致 | 手动映射 | Sequelize模型定义 |

---

## 附录：快速参考

### A. 常用命令

```bash
# 安装依赖
npm install

# 开发模式
npm run dev

# 生产模式
npm start

# 测试数据库连接
node -e "require('./src/config/sequelize')"
```

### B. 响应状态码

| 状态码 | 含义 | 使用场景 |
|-------|------|---------|
| 200 | 成功 | 操作成功 |
| 400 | 请求错误 | 参数错误、业务错误 |
| 401 | 未认证 | token无效/过期 |
| 403 | 禁止访问 | 权限不足、账号禁用 |
| 404 | 未找到 | 资源不存在 |
| 409 | 冲突 | 数据重复 |
| 422 | 验证失败 | 参数验证不通过 |
| 500 | 服务器错误 | 未知错误 |

### C. 环境检查

```bash
# Node.js版本
node -v  # 应该 >= 18

# MySQL版本
mysql -V  # 应该 >= 8.0

# Redis版本
redis-cli --version  # 应该 >= 6.0
```

---

**文档结束** | 版本 v1.0 | 2025-10-08