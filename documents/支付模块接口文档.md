# 支付模块接口文档

## 1. 概述

本文档详细说明了电工平台支付模块的接口使用方法、微信支付对接流程、调试方法以及支付订单创建时机。

## 2. 支付接口调用

### 2.1 创建支付订单

**接口地址**：`POST /api/payments`

**请求参数**：
```json
{
  "order_id": 123,                // 工单ID（必填）
  "payment_method": "wechat"      // 支付方式，可选值：wechat（微信支付）、test（测试支付）
}
```

**响应结果**：
```json
{
  "success": true,
  "data": {
    "payment_id": 456,            // 支付ID
    "payment_no": "P202510201234567890", // 支付单号
    "amount": 100.00,             // 支付金额
    "prepay_id": "wx123456789",   // 微信支付预支付ID
    "sign": "ABCDEFG123456",      // 签名
    "timestamp": "1603123456"     // 时间戳
  }
}
```

### 2.2 查询支付状态

**接口地址**：`GET /api/payments/:payment_no`

**请求参数**：无（payment_no在URL中）

**响应结果**：
```json
{
  "success": true,
  "data": {
    "payment": {
      "id": 456,
      "order_id": 123,
      "user_id": 789,
      "amount": 100.00,
      "payment_method": "wechat",
      "transaction_id": "4200000123456789",
      "out_trade_no": "P202510201234567890",
      "status": "success",        // 支付状态：pending（待支付）、success（已支付）、failed（失败）、refunded（已退款）
      "paid_at": "2025-10-20 12:34:56"
    }
  }
}
```

### 2.3 测试支付确认（仅测试环境）

**接口地址**：`POST /api/payments/test-confirm`

**请求参数**：
```json
{
  "payment_no": "P202510201234567890" // 支付单号
}
```

**响应结果**：
```json
{
  "success": true,
  "message": "测试支付确认成功"
}
```

### 2.4 申请退款

**接口地址**：`POST /api/payments/:payment_no/refund`

**请求参数**：无（payment_no在URL中）

**响应结果**：
```json
{
  "success": true,
  "message": "退款申请已提交"
}
```

## 3. 微信支付对接

### 3.1 对接流程

1. **前端调用创建支付接口**：
   - 调用 `POST /api/payments` 接口创建支付订单
   - 接收返回的支付参数（prepay_id、sign等）

2. **前端唤起微信支付**：
   ```javascript
   wx.requestPayment({
     timeStamp: data.timestamp,
     nonceStr: data.nonce_str,
     package: `prepay_id=${data.prepay_id}`,
     signType: 'MD5',
     paySign: data.sign,
     success(res) {
       // 支付成功，查询支付结果
       queryPaymentStatus(data.payment_no);
     },
     fail(err) {
       // 支付失败或取消
       console.error('支付失败', err);
     }
   });
   ```

3. **后端接收微信支付回调**：
   - 微信支付完成后，会向服务器发送异步通知
   - 服务器通过 `/api/payments/wechat-notify` 接口接收通知
   - 验证通知真实性，更新支付状态

4. **前端查询支付结果**：
   - 调用 `GET /api/payments/:payment_no` 接口查询支付状态
   - 根据返回的支付状态更新界面

### 3.2 配置要求

- 需在微信支付商户平台配置支付回调地址：`https://your-domain.com/api/payments/wechat-notify`
- 需配置商户证书和密钥
- 需在小程序管理后台添加支付相关域名到白名单

## 4. 支付调试方法

### 4.1 测试环境调试

1. **使用测试支付模式**：
   - 创建支付时设置 `payment_method` 为 `test`
   - 调用 `POST /api/payments/test-confirm` 接口模拟支付成功

2. **查看支付日志**：
   - 服务器日志路径：`/var/log/app/payment.log`
   - 包含支付创建、回调处理等详细信息

3. **使用微信支付沙箱环境**：
   - 在开发环境配置中启用沙箱模式
   - 使用沙箱专用的商户号和密钥

### 4.2 常见问题排查

1. **支付创建失败**：
   - 检查工单状态是否为已完成
   - 检查用户是否有权限支付
   - 检查是否已有待支付订单

2. **支付回调未收到**：
   - 检查回调URL配置是否正确
   - 检查服务器防火墙设置
   - 查看微信支付商户平台的回调日志

3. **支付状态查询失败**：
   - 检查支付单号是否正确
   - 检查网络连接是否正常
   - 查看服务器日志中的错误信息

## 5. 支付订单创建时机

### 5.1 适合创建支付订单的场景

1. **工单完成后**：
   - 工单状态为"已完成"时，客户可以进行支付
   - 系统会验证工单状态，未完成的工单无法创建支付

2. **用户确认服务满意后**：
   - 用户确认服务质量后，可以进行支付
   - 建议在用户评价后引导支付

3. **预付款场景**：
   - 某些特殊服务可能需要预付款
   - 此时可在工单创建时就生成支付订单

### 5.2 避免创建支付订单的情况

1. **工单未完成**：系统会拒绝为未完成的工单创建支付

2. **已有待支付订单**：同一工单已有待支付订单时，需先完成或取消现有支付

3. **工单已支付**：系统会检查工单支付状态，避免重复支付

## 6. 最佳实践

1. **前端实现**：
   - 支付按钮应在工单完成后才启用
   - 支付过程中显示加载状态
   - 支付完成后主动查询支付结果

2. **异常处理**：
   - 实现支付超时处理机制
   - 提供支付失败的重试选项
   - 支付取消后的友好提示

3. **安全建议**：
   - 所有支付相关接口必须使用HTTPS
   - 验证用户身份和权限
   - 支付金额与订单金额二次校验