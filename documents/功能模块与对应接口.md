
# 功能模块与对应接口
更新日期：2025-10-18

## 小程序端

### 用户认证模块【测试通过10.16】

- 发送验证码： POST /api/auth/send-code
- 用户登录/注册： POST /api/auth/login
- 获取用户信息： GET /api/auth/userinfo
- 更新用户信息： PUT /api/auth/profile
- 切换用户角色： POST /api/auth/switch-role
- 刷新token： POST /api/auth/refresh-token
- 用户登出： POST /api/auth/logout
- 验证token： GET /api/auth/verify-token

### 用户资料模块【测试通过10.16】

- 获取用户资料： GET /api/users/profile
- 更新用户资料： PUT /api/users/profile

### 电工认证模块【测试通过10.16】

- 提交电工认证申请： POST /api/electricians/certification【测试通过】
- 获取认证状态： GET /api/electricians/certification/status【测试通过】

### 地址管理模块

- 添加地址： POST /api/addresses
- 获取地址列表： GET /api/addresses
- 获取地址详情： GET /api/addresses/:id
- 更新地址： PUT /api/addresses/:id
- 删除地址： DELETE /api/addresses/:id
- 设置默认地址： PUT /api/addresses/:id/default

### 消息模块

- 获取用户消息列表： GET /api/messages
- 获取消息详情： GET /api/messages/:id
- 标记消息为已读： PUT /api/messages/:id/read
- 获取未读消息数量： GET /api/messages/unread/count

### 订单模块

- 创建工单： POST /api/orders【测试通过】
  - 请求参数：
  ```json
  {
    "title": "工单标题（必填，2-100字符）",
    "description": "工单描述（必填，最多1000字符）",
    "service_type_id": "服务类型ID（必填，整数）",
    "address_id": "地址ID（必填，整数）",
    "expected_time": "期望服务时间（必填，ISO8601格式）",
    "images": ["图片URL数组（可选）"]
  }
  ```
  - 返回参数：
  ```json
  {
    "code": 200,
    "message": "工单创建成功",
    "data": {
      "id": "工单ID",
      "title": "工单标题",
      "description": "工单描述",
      "status": "pending",
      "created_at": "创建时间"
    }
  }
  ```

- 获取工单列表： GET /api/orders【测试通过】
  - 请求参数：
  ```json
  {
    "page": "页码（可选，默认1）",
    "limit": "每页数量（可选，默认10）",
    "status": "工单状态（可选）",
    "role": "角色筛选（可选）"
  }
  ```
  - 返回参数：
  ```json
  {
    "code": 200,
    "message": "获取工单列表成功",
    "data": {
      "total": "总数",
      "page": "当前页码",
      "limit": "每页数量",
      "orders": [
        {
          "id": "工单ID",
          "title": "工单标题",
          "status": "工单状态",
          "created_at": "创建时间",
          "address": "服务地址",
          "service_type": "服务类型"
        }
      ]
    }
  }
  ```

- 获取工单详情： GET /api/orders/:id【测试通过】
  - 请求参数：无（通过URL参数传递ID）
  - 返回参数：
  ```json
  {
    "code": 200,
    "message": "获取工单详情成功",
    "data": {
      "id": "工单ID",
      "title": "工单标题",
      "description": "工单描述",
      "status": "工单状态",
      "created_at": "创建时间",
      "expected_time": "期望服务时间",
      "address": {
        "id": "地址ID",
        "province": "省份",
        "city": "城市",
        "district": "区县",
        "detail": "详细地址",
        "contact_name": "联系人",
        "contact_phone": "联系电话"
      },
      "service_type": {
        "id": "服务类型ID",
        "name": "服务类型名称"
      },
      "images": ["图片URL数组"],
      "user": {
        "id": "用户ID",
        "nickname": "用户昵称",
        "avatar": "用户头像"
      },
      "electrician": {
        "id": "电工ID",
        "name": "电工姓名",
        "avatar": "电工头像",
        "phone": "电工电话"
      },
      "amount": "订单金额",
      "update_request": "是否有修改请求",
      "cancel_initiated": "是否有取消请求",
      "cancel_initiator": "取消发起方角色",
      "cancel_reason": "取消原因"
    }
  }
  ```

- 电工抢单： POST /api/orders/:id/take【测试通过】
  - 请求参数：无（通过URL参数传递ID）
  - 返回参数：
  ```json
  {
    "code": 200,
    "message": "抢单成功",
    "data": {
      "id": "工单ID",
      "status": "in_progress",
      "electrician_id": "电工ID"
    }
  }
  ```

- 电工修改订单内容和金额： PUT /api/orders/:id/update【测试通过】
  - 请求参数：
  ```json
  {
    "title": "工单标题（可选，2-100字符）",
    "description": "工单描述（可选，最多1000字符）",
    "amount": "订单金额（必填，数字，不能小于0）",
    "remark": "备注（可选，最多500字符）"
  }
  ```
  - 返回参数：
  ```json
  {
    "code": 200,
    "message": "订单修改请求已提交，等待用户确认",
    "data": {
      "id": "工单ID",
      "title": "工单标题",
      "description": "工单描述",
      "amount": "订单金额",
      "update_request": true
    }
  }
  ```

- 用户确认订单修改： POST /api/orders/:id/confirm-update【测试通过】
  - 请求参数：
  ```json
  {
    "confirm": "是否确认修改（必填，布尔值）"
  }
  ```
  - 返回参数：
  ```json
  {
    "code": 200,
    "message": "订单修改已确认",
    "data": {
      "id": "工单ID",
      "title": "工单标题",
      "description": "工单描述",
      "amount": "订单金额",
      "update_request": false
    }
  }
  ```

- 用户确认工单： POST /api/orders/:id/confirm【测试通过】
  - 请求参数：无（通过URL参数传递ID）
  - 返回参数：
  ```json
  {
    "code": 200,
    "message": "工单确认成功",
    "data": {
      "id": "工单ID",
      "status": "confirmed"
    }
  }
  ```

- 完成服务： POST /api/orders/:id/complete 【测试通过】
  - 请求参数：
  ```json
  {
    "repair_content": "维修内容（可选，最多500字符）",
    "repair_images": ["维修图片URL数组（可选）"]
  }
  ```
  - 兼容参数：
  ```json
  {
    "completion_note": "完成说明（可选，最多500字符）",
    "completion_images": ["完成图片URL数组（可选）"]
  }
  ```
  - 返回参数：
  ```json
  {
    "code": 200,
    "message": "服务完成",
    "data": {
      "id": "工单ID",
      "status": "completed",
      "completed_at": "完成时间"
    }
  }
  ```

- 发起取消订单请求： POST /api/orders/:id/initiate-cancel【新增】
  - 说明：用户可以取消待接单、已接单和进行中状态的订单，电工可以取消已接单和进行中状态的订单。用户取消待接单状态的订单会直接取消，已接单和进行中状态的订单无论是用户还是电工发起取消，都需要对方确认。
  - 请求参数：
  ```json
  {
    "reason": "取消原因（必填，最多500字符）"
  }
  ```
  - 返回参数（进行中状态取消）：
  ```json
  {
    "code": 200,
    "message": "取消请求已发起，等待对方确认",
    "data": {
      "id": "工单ID",
      "cancel_initiated": true,
      "cancel_initiator": "发起方角色",
      "cancel_reason": "取消原因"
    }
  }
  ```
  - 返回参数（用户取消待接单状态）：
  ```json
  {
    "code": 200,
    "message": "订单已取消",
    "data": {
      "id": "工单ID",
      "status": "cancelled",
      "cancel_reason": "取消原因"
    }
  }
  ```

- 确认取消订单： POST /api/orders/:id/confirm-cancel【新增】
  - 请求参数：
  ```json
  {
    "confirm": "是否确认取消（必填，布尔值）"
  }
  ```
  - 返回参数：
  ```json
  {
    "code": 200,
    "message": "订单已取消",
    "data": {
      "id": "工单ID",
      "status": "cancelled",
      "cancel_time": "取消时间"
    }
  }
  ```

- 获取工单统计： GET /api/orders/stats/summary
  - 请求参数：
  ```json
  {
    "start_date": "开始日期（可选，YYYY-MM-DD格式）",
    "end_date": "结束日期（可选，YYYY-MM-DD格式）"
  }
  ```
  - 返回参数：
  ```json
  {
    "code": 200,
    "message": "获取工单统计成功",
    "data": {
      "total": "总工单数",
      "pending": "待接单数",
      "in_progress": "进行中数",
      "completed": "已完成数",
      "cancelled": "已取消数",
      "confirmed": "已确认数"
    }
  }
  ```

### 支付模块

- 创建支付订单： POST /api/payments
- 测试支付确认： POST /api/payments/test/confirm
- 微信支付回调： POST /api/payments/wechat/notify
- 查询支付状态： GET /api/payments/:payment_no
- 获取支付列表： GET /api/payments
- 获取支付统计： GET /api/payments/stats/summary
- 申请退款： POST /api/payments/:payment_no/refund



#=## PC后台管理

### 管理员模块

- 管理员登录： POST /api/admin/auth/login
- 获取管理员信息： GET /api/admin/auth/info
- 管理员登出： POST /api/admin/logout

### 用户管理

- 获取用户列表： GET /api/admin/users
- 获取用户详情： GET /api/admin/users/:id
- 修改用户状态： PUT /api/admin/users/:id/status

### 电工管理

- 获取电工列表： GET /api/admin/electricians
- 获取电工详情： GET /api/admin/electricians/:id
- 审核电工认证： PUT /api/admin/electricians/:id/review
- 修改电工状态： PUT /api/admin/electricians/:id/status

### 订单管理

- 获取订单列表： GET /api/admin/orders
- 获取订单详情： GET /api/admin/orders/:id
- 更新订单状态： PUT /api/admin/orders/:id/status
- 处理退款申请： PUT /api/payments/:payment_no/refund

### 数据统计

- 获取平台统计数据： GET /api/admin/statistics

### 系统通知管理

- 获取通知列表： GET /api/admin/messages
- 创建系统通知： POST /api/admin/messages
- 获取通知详情： GET /api/admin/messages/:id
- 更新系统通知： PUT /api/admin/messages/:id
- 删除系统通知： DELETE /api/admin/messages/:id