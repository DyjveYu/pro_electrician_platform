# 后续优化

## - 方法级限流：
   - 全局仅对 POST/PUT/PATCH/DELETE 应用限流， GET 放宽或不限制；这样更贴合实际业务且更安全。需要我进一步改成方法感知的中间件可以继续安排。
- 列表页的“取消订单”如果仍用 POST ，建议统一改为 PUT 与后端路由一致。
- 没有实现“30分钟未支付自动关闭”的到期处理。


## 现状与建议：
- 当前 cancelOrder 仅允许在 pending 、 accepted 取消，尚未覆盖 pending_repair_payment 场景，也未自动触发退款。
- 建议后续改造：
  - 允许用户在 pending_repair_payment 取消；
  - 若 has_paid_repair === true 且尚未 in_progress ，调用退款流程（你已有 PaymentController.requestRefund/processRefund 基础）；
  - 退款成功后把订单状态改为 cancelled 并记录日志、消息；退款失败进入人工处理通道。
- 这样就能完全实现“支付成功但未开工可取消并退款”的规则。此改造我可以在你确认后继续提交。

# 本版本优化
订单主状态流转保持： pending_repair_payment → in_progress → completed （你后续若要引入 pending_review ，建议将电工完成后进入 pending_review ，用户评价后变为 completed ）


如果你认可当前后端改动与前端显示条件说明，我可以继续把“取消并退款（在 pending_repair_payment 且已支付）”的逻辑补上，或者先由你这边联调验证现有接口再推进下一步

# 前端选择地址和时间的问题：
- 方案 C｜后端支持“用地址ID下单”，由后端自行取地址信息（推荐长期方案）
  
  - 新增或扩展订单创建协议：提交 address_id （以及 service_type_id 、 expected_time 等），后端读取地址表填充 contact_name / phone / service_address / latitude / longitude ；
  - 前端省去重复提交地址详情，只提交 address_id + ISO 时间；
  - 优点：数据一致性更好，减少重复字段；后端可统一处理缺失坐标（如触发补录或用行政区兜底）。
  - 成本：需要调整后端接口与前端调用，改动略大，但架构更干净。
我的建议

- 立即止血：选 B（后端放宽经纬度必填）+ 前端把时段转 ISO。这样你现在就能下单成功，不影响已有地址。
- 紧接着优化体验：前端按照 A 增强地址选择与补录（映射经纬度 + 无坐标提示地图选点），逐步提高订单的坐标覆盖率。
- 中长期演进：落地 C，用 address_id 下单，消除前端重复字段与后端校验不一致的问题。
需要你拍板的两点

- 是否接受“先放宽经纬度必填”的快速修复（B），随后做前端补齐（A），并在下一迭代推进地址ID下单（C）？
- expected_time 的语义：用“时段开始时间”即可，还是需要同时保存“开始/结束”两个字段？如果要保留时段范围，我会在订单模型加 expected_start_time 和 expected_end_time 两列，前端仍提交 ISO。
若选择“快速修补”（B+A中的时间ISO），前端改动示例

- 地址列表保留经纬度，选择地址同步到页面状态：
  - 在 loadAddresses 映射里加 latitude: item.latitude , longitude: item.longitude ；
  - 在 selectAddress 里 this.setData({ latitude: address.latitude || null, longitude: address.longitude || null }) 。
- 将时段转换为 ISO（取开始时间）：
  - 从 dateList[selectedDateIndex].date 和 selectedSlot 拆出年月日与开始时分，生成 new Date(year, month-1, day, hour, minute, 0) ，再 toISOString() 或拼 +08:00 ：
  - 例： const iso = new Date(y, m-1, d, hh, mm).toISOString(); 或 const iso = \ ${y}-${pad(m)}-${pad(d)}T${pad(hh)}:${pad(mm)}:00+08:00`;`
- 提交时 expected_time 用该 iso 字符串； latitude / longitude 若无就传 null 。
验收标准

- 选择已有老地址（无经纬度）也能成功下单，不再出现“纬度必须是数字/经度必须是数字/时间必须是ISO格式”的 422；
- 选择已补录定位或从地图选点的地址，下单包含有效坐标；
- 时间字段在后端能通过 Joi.date().iso() 校验，无需后端改动就能落单

## 后续迭代（按你的确认）

- 推进“仅提交 address_id 下单”的接口与前端改造，减少前端重复字段并由后端统一填充地址信息。
- 逐步在地址编辑页支持采集与保存经纬度，以提升“附近电工、就近派单”等能力。