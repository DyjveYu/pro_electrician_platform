# 着安-电工维修平台微信小程序产品需求文档
版本号： V1.0.2
文档说明：需求新增和变更文档，仅仅包含新增和变更的需求，不包含已完成的需求。

## 1. 产品概述

着安电工维修平台是一个基于微信小程序的O2O服务平台，连接有维修需求的客户和专业电工。客户可以在线预付定金下单预约维修，电工接单或系统自动派单，双方确定维修金额后客户支付剩余维修金，电工完成服务后客户对电工进行评价，实现维修服务的数字化闭环。

## 2. 功能变更
### 小程序端：
1. 首页：
    电工页面抢单按钮改为接单按钮，电工点击接单后，页面跳转到订单详情页，展示订单详情和接单按钮；
    电工点击接单按钮后，提示“接单成功”，订单状态改为已接单，用户可联系电工，进行服务。
2. 订单：
    **页面调整**：
   1）顶部4个tab（待接单、进行中、待支付、已完成）改为一个tab：我的订单
   2）电工端：显示所有自己已接单的订单，包括已接单、待支付维修费、维修中、待评价、已完成状态的订单。
   3）普通用户端：显示所有自己已下单的订单，包括待支付预付款、交易关闭、待接单、已接单、待支付维修费、维修中、待评价、已完成状态的订单。

## 3.业务流程和状态调整（包含五项）
### 一、订单状态词汇表
| 状态编号 | 系统标识（英文常量）               | 中文展示名（前端展示） | 状态说明（业务逻辑）                |
| ---- | ------------------------ | ----------- | ------------------------- |
| 1    | `pending_deposit`        | 待支付预付款      | 用户已提交订单但尚未支付定金。           |
| 2    | `closed`                 | 交易关闭        | 用户取消或超时（30分钟未支付定金）。       |
| 3    | `pending_accept`         | 待接单         | 用户已支付预付款，等待电工接单。          |
| 4    | `accepted`               | 已接单         | 电工已接单，等待上门服务。             |
| 5    | `pending_repair_payment` | 待支付维修费      | 电工提交维修金额和维修内容，等待用户支付维修费用。 |
| 6    | `in_progress`              | 维修中         | 用户已支付维修费后，电工点击“开始维修”进入维修中。中。         |
| 7    | `pending_review`         | 待评价         | 电工完成维修，等待用户评价。            |
| 8    | `completed`              | 已完成         | 用户完成评价，订单流程结束。            |

### 二、状态流转图（简化）
待支付预付款 (pending_deposit)
     │  ├── 支付成功 → 待接单 (pending_accept)
     │  ├── 支付失败 / 超时 → 交易关闭 (closed)
     │  └── 用户取消 → 交易关闭 (closed)
待接单 (pending_accept)
     └── 电工接单 → 已接单 (accepted)
已接单 (accepted)
     └── 电工提交维修方案 → 待支付维修费 (pending_repair_payment)
待支付维修费 (pending_repair_payment)
     └── 用户支付维修费 → 维修中 (in_progress)
维修中 (in_progress)
     └── 电工完成维修 → 待评价 (pending_review)
待评价 (pending_review)
     └── 用户完成评价 → 已完成 (completed)

### 三、建议的数据库设计（字段值）
// orders.status 字段建议枚举值
status ENUM(
  'pending_deposit',        // 待支付预付款
  'closed',                 // 交易关闭
  'pending_accept',         // 待接单
  'accepted',               // 已接单
  'pending_repair_payment', // 待支付维修费
  'in_repair',              // 维修中
  'pending_review',         // 待评价
  'completed'               // 已完成
)

### 四、建议前端展示文字与颜色规范
| 状态     | 显示文字   | 建议颜色         | 备注     |
| ------ | ------ | ------------ | ------ |
| 待支付预付款 | 待支付预付款 | 橙色 (#FFA500) | 提醒用户支付 |
| 交易关闭   | 交易关闭   | 灰色 (#999999) | 已终止    |
| 待接单    | 待接单    | 蓝色 (#1890FF) | 等待电工   |
| 已接单    | 已接单    | 绿色 (#52C41A) | 电工已接单  |
| 待支付维修费 | 待支付维修费 | 橙色 (#FFA500) | 等用户支付  |
| 维修中    | 维修中    | 蓝色 (#1890FF) | 服务进行中  |
| 待评价    | 待评价    | 紫色 (#722ED1) | 等用户反馈  |
| 已完成    | 已完成    | 绿色 (#52C41A) | 订单结束   |

### 五、状态辅助字段建议（便于后期扩展）
// 可加以下字段方便统计与追踪：
prepayment_amount   // 预付款金额
repair_amount       // 维修费金额
prepayment_paid_at  // 预付款支付时间
repair_paid_at      // 维修费支付时间
accepted_at         // 电工接单时间
completed_at        // 用户完成评价时间
closed_reason       // 交易关闭原因（超时/用户取消）

### 六、用户操作描述
    1）用户打开小程序，点击首页“立即下单”按钮，跳转到下单表单页。
    2）用户填写服务类型、问题描述、图片、维修地点、时间、联系人、联系手机号、查看预付款金额、查看预付款备注说明，点击“立即预约”，弹出微信支付页面。
    3）用户上一步完成支付，订单状态为待接单；用户没完成支付，订单状态为待支付预付款；用户在30分钟内未完成支付，订单状态改为交易关闭。
    4）电工在首页点击“接单”按钮，订单状态改为已接单。
    5）电工在订单详情页输入维修金额和维修内容，点击“提交”，订单状态改为待支付维修费。
    6）用户支付维修费，订单状态改为维修中。
    7）电工完成服务，订单状态改为待评价。
    8）用户完成评价电工，订单状态改为已完成。
          
3. 消息：
    **订单通知**
    用户端：用户自己下订单状态为待支付预付款、已接单、待支付维修费、待评价时，收到订单通知。
    电工端：电工自己接的订单状态为已完成时，收到订单通知。
    消息模板：订单xxxxxxx+订单状态

4. 我的：角色选择入口改为开关形式，用户可以在我的页面切换角色（电工/普通用户）。

## 3. 用户界面设计
💚 小程序界面设计 Prompt（绿色渐变风格）
主色调：绿色系（顶部深绿色 #0F9D58 → 底部浅绿色 #A5D6A7 渐变）
整体页面背景采用自上而下的绿色渐变过渡，视觉清新自然。
辅助色：
白色（#FFFFFF，用于卡片背景、主要内容区）
灰色（#F5F5F5 用于页面背景分区，#666666 用于文字说明）

按钮样式：
大圆角矩形（border-radius: 24px）
背景为绿色渐变（#0F9D58 → #81C784）
按钮文字为黑色（#000000）
轻微阴影效果，悬停时亮度增强

字体：
微信小程序默认字体
标题：16px，正文：14px，辅助文字：12px
字体颜色以深灰或黑色为主，保持良好对比度

布局风格：
卡片式设计，整体圆角、留白感强
顶部导航栏采用渐变色背景，与主色系统一
底部 Tab 栏采用半透明毛玻璃效果

图标风格：
线性简洁图标，主色调为绿色（#0F9D58）
现代扁平风格，适度留白，简洁不复杂

渐变效果：
页面背景：从深绿渐变到浅绿
按钮与重点区域使用绿色渐变突出层次感
用户信息卡片和主要操作区可使用轻微渐变作为视觉强化

卡片式设计：

所有卡片采用圆角（16px）与浅阴影（blur 4px, rgba(0,0,0,0.1)）
白色背景、绿色图标、灰色文字的组合风格

整体氛围：
自然、清爽、专业
视觉层次分明，兼顾现代科技感与亲和力

## 需求分析
### 最终确认的需求

- 状态词与流转对齐：
  - 采用八个状态词：`待支付预付款`、`交易关闭`、`待接单`、`已接单`、`待支付维修费`、`维修中`、`待评价`、`已完成`。
  - 移除“进行中”状态词，统一使用“维修中”。
- 首页与接单流程：
  - 电工端首页显示“接单”入口，点击后跳转到订单详情页，详情页再次确认“接单”并提示“接单成功”，订单状态改为“已接单”。
- 业务流程节点：
  - 客户下单并支付预付款后进入“待接单”；未支付时为“待支付预付款”。
  - 暂不启用“预付款30分钟未支付自动关闭”，当前以用户主动取消或运营后台关闭为准。
  - 电工在订单详情提交“维修金额”和“维修内容”后，订单进入“待支付维修费”；客户支付后进入“维修中”；电工完成后进入“待评价”；用户评价后进入“已完成”。
- 报价相关：
  - 取消“报价/quoted_price”概念；电工仅提交“维修金额”和“维修内容”。后端与数据库不新增“quoted_price”字段。
- 消息通知：
  - 模板为“订单xxxxxxx + 订单状态”，触发节点：待支付预付款、已接单、待支付维修费、待评价（用户端）；已完成（电工端）。
- 支付模块：
  - 保持“预付款 + 维修费”双阶段支付方案；模块已调试，可在后续迭代中进行细粒度规则优化。
- 角色切换：
  - 我的页面提供角色开关（电工/普通用户）；当前仅做前端本地实现，无需后端持久化。
- 评价与完成：
  - 已确认存在评论表用于存储评价。是否强制评价为必填暂未确认，现阶段按“评价后进入已完成”执行，后续可调整。
- 接口契约：
  - 请求与响应按产品文档对齐；去除所有接口中的“quoted_price”参数与校验。

## 修改策略与阶段工作任务清单

说明：本清单为实施阶段划分与任务概要，仅用于开发计划与验收对齐，当前阶段不进行代码改动。

- 阶段1：接口契约与状态词对齐
  - 后端：统一订单状态枚举与常量；去除 quoted_price 处理；更新校验规则与响应结构。
  - 小程序：状态词映射与展示统一；移除报价输入与相关文案；调整 API 参数。
  - 统一前端成功判断为 code === 200 && message === 'success' ，避免误判。
  - 保持后端返回结构不变（ res.success / res.error ），不引入双态。

- 阶段2：首页接单流程改造
  - 小程序：将“抢单”改为“接单”；接单流程跳转订单详情与成功提示；异常与并发提示。
  - 后端：接单接口幂等与并发保护；状态更新为“已接单”。takeOrder 接口仅绑定 electrician_id 并更新订单状态为 accepted ；记录状态日志与消息（模板： 订单{order_no} 已接单 ，用户端）。

- 阶段3：订单列表与详情重构
  - 小程序：合并为“我的订单”；按状态分组与筛选；详情页新增维修金额与维修内容提交。
  - 后端：列表接口支持分页与状态过滤；详情接口字段对齐。

- 阶段4：支付与状态流转完善
  - 小程序：预付款与维修费支付流程；成功/取消回调处理；异常提示。
  - 后端：支付回调与状态流转；暂不实现预付超时自动关闭；支持手动取消。

- 阶段5：消息通知模板与发送
  - 后端：按确认节点触发消息；模板“订单xxxxxxx + 订单状态”；用户端与电工端区分。
  - 小程序：订阅开关与提醒入口；文案对齐。

- 阶段6：评价与已完成闭环
  - 小程序：评价表单与提交；当前策略为评价后置为“已完成”；后续是否强制评价待确认。
  - 后端：评论表写入；订单状态更新为“已完成”。

- 阶段7：角色切换与体验
  - 小程序：我的页角色开关；本地存储持久化；页面刷新策略。
  - 后端：不改动；如需服务端持久化另行评估。

- 阶段8：数据与清理
  - 后端：移除历史报价相关代码路径；数据库与模型不新增 quoted_price；编写迁移与回滚策略（若必要）。
  - 文档：接口文档与产品文档同步更新，确保客户/电工端文案一致。

- 阶段9：测试与验收
  - 测试：单元、接口、端到端（小程序）回归；覆盖关键状态流转与支付。
  - 验收：以任务清单为准，逐项演示并记录通过结果。




修改策略（分阶段推进，后端优先对齐契约 → 前端交互 → 列表与状态映射 → 消息 → 支付与完成）

- 阶段1｜契约与成功判断对齐（后端+前端）
  
  - 统一前端成功判断为 code === 200 && message === 'success' ，避免误判。
  - 保持后端返回结构不变（ res.success / res.error ），不引入双态。
  - 不涉及 UI，风险最低，先做以稳定数据流。


- 阶段2｜首页接单流程改造（前端为主，后端配合）
  
  - 前端：电工首页按钮改为“接单”，点击跳订单详情页，详情页显示“接单”按钮与确认弹窗；移除所有“报价”输入与逻辑。
  - 后端： takeOrder 接口仅绑定 electrician_id 并更新订单状态为 accepted ；记录状态日志与消息（模板： 订单{order_no} 已接单 ，用户端）。
  - 技术规范：后端使用 Sequelize 模型与事务、 include / Op 条件，禁止原始 SQL 与复杂 literal，错误统一 next(AppError) 。

- 阶段3｜订单列表与“展示层状态映射”（前端+后端）
  
  - 前端：整合为“我的订单”单一 Tab，按角色显示范围；通过展示层规则把后端枚举映射为八个状态文案。
  - 后端：增强 getOrderList 支持角色/状态筛选（ findAndCountAll + where + include ），保留分页与返回结构。
  - 展示层状态映射建议（数据库枚举不改，前端按条件推断）：
    - 待支付预付款： Order.status === 'pending' 且未有预付款成功记录。
    - 交易关闭： Order.status === 'cancelled' （或取消相关流程结束）。
    - 待接单：预付款成功， electrician_id 为空， Order.status === 'pending' 。
    - 已接单： Order.status === 'accepted' 。
    - 待支付维修费：电工已提交 final_amount 与 repair_content ，但维修费未支付（订单仍 accepted 或未进入 in_progress ）。
    - 维修中：维修费支付成功后进入 in_progress （建议在支付回调时将 Order.status 更新为 in_progress ）。
    - 待评价：电工完成服务（ completed_at 有值或设置 Order.status === 'completed' ），但无 reviews 记录。
    - 已完成：存在 reviews 记录（前端展示为“已完成”）， Order.status 仍可保持 completed 。
    - 注： cancel_pending 不在本次展示词中，如遇到该状态，前端可暂时归类为“交易关闭（取消处理中）”，或在列表中隐藏。

- 阶段4｜维修提交流与支付联动（后端为主，前端配合）
  
  - 电工提交维修金额与内容：接口写入 final_amount 、 repair_content ，并触发用户端消息模板 订单{order_no} 待支付维修费 。
  - 维修费支付成功：在支付回调中将订单状态置为 in_progress ，触发“维修中”展示；记录 paid_at 与支付记录。
  - 服务完成：接口设置 completed_at （或 Order.status === 'completed' ），触发用户端“待评价”的通知。
  - 用户评价：写入 reviews ，前端展示为“已完成”；电工端收到“已完成”通知。
- 阶段5｜消息模板与通知（后端+前端）
  
  - 触发点与角色：
    - 用户端：待支付预付款、已接单、待支付维修费、待评价。
    - 电工端：已完成。
  - 模板示例： 订单{order_no} {状态文案} ；根据角色使用不同模板字典与推送渠道（系统消息/订单消息）。
  - 技术实现：使用消息模型与 Sequelize 关联查询统计（未读/已读），禁止原始 SQL。
- 阶段6｜角色切换与界面风格（前端）
  
  - 角色开关在“我的”页本地保存（如已有则复核交互与刷新策略）；切换联动首页与订单列表范围。
  - 绿色渐变风格落地在全局样式与通用组件（按钮、卡片、导航、Tab），抽取样式变量以统一风格。



  # 验证
  环境与数据库

- 验证 .env 数据库连接配置正确
  - 关键项： DB_HOST 、 DB_PORT 、 DB_USER 、 DB_PASSWORD 、 DB_NAME 。
  - 预期：后端启动日志出现“✅ 数据库连接成功”，无 ECONNREFUSED 。
- 执行迁移脚本并自检列
  - 必须执行：
    - backend/migrations/update_service_types_add_prepay_fields.sql
    - backend/migrations/update_payments_add_type_and_expired.sql
    - backend/migrations/update_orders_add_pending_payment_and_closed.sql
    - backend/migrations/update_orders_cancel_fields.sql （建议先执行取消字段，再执行含 pending_payment/closed 的状态扩充脚本，以免覆盖）
  - 额外新增（用于退款与失败原因）：
    - payments.refund_status 、 refund_reason 、 refund_requested_at 、 refund_id 、 refund_completed_at 、 admin_notes
    - payments.failed_reason
  - 快速自检：
    - SHOW COLUMNS FROM payments LIKE 'type'; （存在）
    - SELECT COLUMN_TYPE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='payments' AND COLUMN_NAME='status'; （包含 expired ）
    - SHOW COLUMNS FROM orders LIKE 'prepaid_at'; （存在）
    - SELECT COLUMN_TYPE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='orders' AND COLUMN_NAME='status'; （包含 pending_payment 、 closed ）
    - SHOW COLUMNS FROM service_types LIKE 'prepay_amount'; 、 prepay_note （存在）
    - SHOW COLUMNS FROM payments LIKE 'refund_status'; 、 failed_reason （存在）
路由与校验

关联接口清单

- 支付相关
  - 创建支付： POST /api/payments （ type=prepay|repair ；微信需 openid ）
  - 测试支付确认： POST /api/payments/test/confirm （参数 payment_no ）
  - 查询支付： GET /api/payments/:payment_no
  - 申请退款： POST /api/payments/:payment_no/refund
  - 微信回调（如需联调）： POST /api/payments/wechat/notify （生产由微信调用）
- 订单相关
  - 接单（电工）： POST /api/orders/:id/take
  - 用户确认开始服务： PUT /api/orders/:id/confirm （部分客户端使用 POST /api/orders/:id/confirm ，后端已兼容）
  - 完成服务（电工）： POST /api/orders/:id/complete
  - 电工修改内容与金额： PUT /api/orders/:id/update ，用户确认： POST /api/orders/:id/confirm-update
  - 取消订单（用户在待接单/已接单）： POST /api/orders/:id/cancel
  - 发起取消与确认取消（已接单/进行中）： POST /api/orders/:id/initiate-cancel 、 POST /api/orders/:id/confirm-cancel
  - 订单列表筛选： GET /api/orders?status=... （ pending_payment|pending|accepted|in_progress|completed|cancelled|closed ）
按流转图的验证建议

- 待支付预付款 → 待接单
  - 创建预付款： POST /api/payments （ type=prepay ）后订单应为 pending_payment
  - 支付成功（用测试确认更快）： POST /api/payments/test/confirm → 订单变为 pending ，消息与状态日志产生
- 支付失败/超时 → 交易关闭
  - 失败：模拟微信失败或直接检查失败写入；当前不会自动把订单变 closed
  - 超时：预付款超时自动关闭任务已临时停用；如需验证可手动将该支付设为 expired 并将订单改为 closed （或待恢复定时任务后再测）
- 用户取消 → 交易关闭
  - 待接单取消： POST /api/orders/:id/cancel → 订单为 cancelled
  - 已接单/进行中取消： POST /api/orders/:id/initiate-cancel → 对方 POST /api/orders/:id/confirm-cancel 后为 cancelled
- 待接单 → 已接单
  - 电工接单： POST /api/orders/:id/take → 订单为 accepted
- 已接单 → 待支付维修费
  - 电工提交方案/金额： PUT /api/orders/:id/update → 用户 POST /api/orders/:id/confirm-update
  - 创建维修费支付： POST /api/payments （ type=repair ）
- 待支付维修费 → 维修中
  - 当前实现为：维修费支付成功后订单置为 paid ；用户确认后服务进入 in_progress （“维修中”）
- 维修中 → 待评价
  - 电工完成： POST /api/orders/:id/complete → 订单为 completed （“待评价”阶段未单独区分）
- 待评价 → 已完成
  - 当前未区分“待评价/已评价”，完成后即 completed ；评价功能若后续启用再补测
额外提示

- 为提高验证稳定性，建议优先用测试支付接口（ payment_method=test + POST /api/payments/test/confirm ），避免微信联调的外部依赖。
- 由于“预付款超时关闭任务”已停用，你无需验证自动关闭；待数据库字段补齐并恢复任务后再安排此用例。
- 后端需确保数据库已执行迁移，特别是 payments.type/expired 以及退款字段，否则部分用例会写库失败。