
# 功能模块与对应接口
更新日期：2025-11-08

## 第一部分：功能模块与接口清单

### 小程序端

#### 用户认证模块【测试通过10.16】

- 发送验证码： POST /api/auth/send-code【测试通过】
- 用户登录/注册： POST /api/auth/login【测试通过】
- 获取用户信息： GET /api/auth/userinfo【测试通过】
- 更新用户信息： PUT /api/auth/profile【测试通过】
- 切换用户角色： POST /api/auth/switch-role【测试通过】
- 刷新token： POST /api/auth/refresh-token【测试通过】
- 用户登出： POST /api/auth/logout【测试通过】
- 验证token： GET /api/auth/verify-token

#### 用户资料模块【测试通过10.16】

- 获取用户资料： GET /api/users/profile【测试通过】
- 更新用户资料： PUT /api/users/profile【测试通过】

#### 电工认证模块【测试通过10.16】

- 提交电工认证申请： POST /api/electricians/certification【测试通过】
- 获取认证状态： GET /api/electricians/certification/status【测试通过】

#### 地址管理模块【测试通过10.21】

- 添加地址： POST /api/addresses
- 获取地址列表： GET /api/addresses
- 获取地址详情： GET /api/addresses/:id
- 更新地址： PUT /api/addresses/:id
- 删除地址： DELETE /api/addresses/:id
- 设置默认地址： PUT /api/addresses/:id/default

#### 消息模块【测试通过10.21】

- 获取用户消息列表： GET /api/messages
- 获取消息详情： GET /api/messages/:id 
- 标记消息为已读： PUT /api/messages/:id/read
- 获取未读消息数量： GET /api/messages/unread/count

#### 订单模块【测试通过10.20】

- 创建工单： POST /api/orders【测试通过】
- 获取工单列表： GET /api/orders【测试通过】
- 获取工单详情： GET /api/orders/:id【测试通过】
- 电工抢单： POST /api/orders/:id/take【测试通过】
- 电工修改订单内容和金额： PUT /api/orders/:id/update【测试通过】
- 用户确认订单修改： POST /api/orders/:id/confirm-update【测试通过】
- 用户确认工单： PUT /api/orders/:id/confirm【测试通过】
- 电工开始维修： PUT /api/orders/:id/start【新增11.8】
- 完成服务： POST /api/orders/:id/complete【测试通过】
- 用户评价订单： PUT /api/orders/:id/review【新增11.8】
- 发起取消订单请求： POST /api/orders/:id/initiate-cancel【测试通过】
- 确认取消订单： POST /api/orders/:id/confirm-cancel【测试通过】
- 取消工单： PUT /api/orders/:id/cancel【测试通过】
- 获取工单统计： GET /api/orders/stats/summary【测试通过】

#### 支付模块

- 创建支付订单： POST /api/payments【通过测试10.21】
- 测试支付确认： POST /api/payments/test/confirm
- 微信支付回调： POST /api/payments/wechat/notify
- 查询支付状态： GET /api/payments/:payment_no
- 获取支付列表： GET /api/payments
- 获取支付统计： GET /api/payments/stats/summary
- 申请退款： POST /api/payments/:payment_no/refund

### PC后台管理

#### 管理员模块

- 管理员登录： POST /api/admin/auth/login
- 获取管理员信息： GET /api/admin/auth/info
- 管理员登出： POST /api/admin/logout

#### 用户管理

- 获取用户列表： GET /api/admin/users
- 获取用户详情： GET /api/admin/users/:id
- 修改用户状态： PUT /api/admin/users/:id/status

#### 电工管理

- 获取电工列表： GET /api/admin/electricians
- 获取电工详情： GET /api/admin/electricians/:id
- 审核电工认证： PUT /api/admin/electricians/:id/review
- 修改电工状态： PUT /api/admin/electricians/:id/status

#### 订单管理

- 获取订单列表： GET /api/admin/orders
- 获取订单详情： GET /api/admin/orders/:id
- 更新订单状态： PUT /api/admin/orders/:id/status
- 处理退款申请： PUT /api/payments/:payment_no/refund

#### 数据统计

- 获取平台统计数据： GET /api/admin/statistics

#### 系统通知管理

- 获取通知列表： GET /api/admin/messages
- 创建系统通知： POST /api/admin/messages
- 获取通知详情： GET /api/admin/messages/:id
- 更新系统通知： PUT /api/admin/messages/:id
- 删除系统通知： DELETE /api/admin/messages/:id

## 第二部分：接口详细说明

### 小程序端接口
#### 用户认证模块
##### 发送验证码
- 接口：POST /api/auth/send-code
- 请求参数：
```json
{
  "phone": "手机号码（必填，11位数字）"
}
```
- 返回参数：
```json
{
  "code": 200,
  "message": "验证码发送成功",
  "data": {
    "expiry": "验证码有效期（秒）"
  }
}
```

##### 用户登录/注册
- 接口：POST /api/auth/login
- 请求参数：
```json
{
  "phone": "手机号码（必填，11位数字）",
  "code": "验证码（必填，6位数字）"
}
```
- 返回参数：
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "JWT令牌",
    "refresh_token": "刷新令牌",
    "user": {
      "id": "用户ID",
      "phone": "手机号码",
      "nickname": "用户昵称",
      "avatar": "头像URL",
      "role": "当前角色（user/electrician）",
      "roles": ["用户拥有的角色数组"]
    }
  }
}
```

##### 获取用户信息
- 接口：GET /api/auth/userinfo
- 请求参数：无（需要在请求头中包含token）
- 返回参数：
```json
{
  "code": 200,
  "message": "获取用户信息成功",
  "data": {
    "id": "用户ID",
    "phone": "手机号码",
    "nickname": "用户昵称",
    "avatar": "头像URL",
    "role": "当前角色（user/electrician）",
    "roles": ["用户拥有的角色数组"],
    "created_at": "创建时间"
  }
}
```

##### 更新用户信息
- 接口：PUT /api/auth/profile
- 请求参数：
```json
{
  "nickname": "用户昵称（可选）",
  "avatar": "头像URL（可选）"
}
```
- 返回参数：
```json
{
  "code": 200,
  "message": "用户信息更新成功",
  "data": {
    "id": "用户ID",
    "nickname": "更新后的昵称",
    "avatar": "更新后的头像URL"
  }
}
```

##### 切换用户角色
- 接口：POST /api/auth/switch-role
- 请求参数：
```json
{
  "role": "要切换的角色（必填，user/electrician）"
}
```
- 返回参数：
```json
{
  "code": 200,
  "message": "角色切换成功",
  "data": {
    "role": "当前角色"
  }
}
```

##### 刷新token
- 接口：POST /api/auth/refresh-token
- 请求参数：
```json
{
  "refresh_token": "刷新令牌（必填）"
}
```
- 返回参数：
```json
{
  "code": 200,
  "message": "令牌刷新成功",
  "data": {
    "token": "新的JWT令牌",
    "refresh_token": "新的刷新令牌"
  }
}
```

##### 用户登出
- 接口：POST /api/auth/logout
- 请求参数：无（需要在请求头中包含token）
- 返回参数：
```json
{
  "code": 200,
  "message": "登出成功"
}
```

##### 验证token
- 接口：GET /api/auth/verify-token
- 请求参数：无（需要在请求头中包含token）
- 返回参数：
```json
{
  "code": 200,
  "message": "令牌有效",
  "data": {
    "valid": true
  }
}
```

#### 地址管理模块

##### 添加地址
- 接口：POST /api/addresses
- 请求参数：
```json
{
  "province": "省份（必填，字符串）",
  "city": "城市（必填，字符串）",
  "district": "区县（必填，字符串）",
  "detail": "详细地址（必填，字符串，最多200字符）",
  "contact_name": "联系人姓名（必填，字符串，最多50字符）",
  "contact_phone": "联系人电话（必填，11位数字）",
  "is_default": "是否设为默认地址（可选，布尔值，默认false）"
}
```
- 返回参数：
```json
{
  "code": 200,
  "message": "地址添加成功",
  "data": {
    "id": "地址ID",
    "province": "省份",
    "city": "城市",
    "district": "区县",
    "detail": "详细地址",
    "contact_name": "联系人姓名",
    "contact_phone": "联系人电话",
    "is_default": "是否为默认地址",
    "created_at": "创建时间"
  }
}
```

##### 获取地址列表
- 接口：GET /api/addresses
- 请求参数：无（需要在请求头中包含token）
- 返回参数：
```json
{
  "code": 200,
  "message": "获取地址列表成功",
  "data": [
    {
      "id": "地址ID",
      "province": "省份",
      "city": "城市",
      "district": "区县",
      "detail": "详细地址",
      "contact_name": "联系人姓名",
      "contact_phone": "联系人电话",
      "is_default": "是否为默认地址",
      "created_at": "创建时间"
    }
  ]
}
```

##### 获取地址详情
- 接口：GET /api/addresses/:id
- 请求参数：无（通过URL参数传递ID）
- 返回参数：
```json
{
  "code": 200,
  "message": "获取地址详情成功",
  "data": {
    "id": "地址ID",
    "province": "省份",
    "city": "城市",
    "district": "区县",
    "detail": "详细地址",
    "contact_name": "联系人姓名",
    "contact_phone": "联系人电话",
    "is_default": "是否为默认地址",
    "created_at": "创建时间",
    "updated_at": "更新时间"
  }
}
```

##### 更新地址
- 接口：PUT /api/addresses/:id
- 请求参数：
```json
{
  "province": "省份（可选，字符串）",
  "city": "城市（可选，字符串）",
  "district": "区县（可选，字符串）",
  "detail": "详细地址（可选，字符串，最多200字符）",
  "contact_name": "联系人姓名（可选，字符串，最多50字符）",
  "contact_phone": "联系人电话（可选，11位数字）",
  "is_default": "是否设为默认地址（可选，布尔值）"
}
```
- 返回参数：
```json
{
  "code": 200,
  "message": "地址更新成功",
  "data": {
    "id": "地址ID",
    "province": "省份",
    "city": "城市",
    "district": "区县",
    "detail": "详细地址",
    "contact_name": "联系人姓名",
    "contact_phone": "联系人电话",
    "is_default": "是否为默认地址",
    "updated_at": "更新时间"
  }
}
```

##### 删除地址
- 接口：DELETE /api/addresses/:id
- 请求参数：无（通过URL参数传递ID）
- 返回参数：
```json
{
  "code": 200,
  "message": "地址删除成功"
}
```

##### 设置默认地址
- 接口：PUT /api/addresses/:id/default
- 请求参数：无（通过URL参数传递ID）
- 返回参数：
```json
{
  "code": 200,
  "message": "默认地址设置成功",
  "data": {
    "id": "地址ID",
    "is_default": true
  }
}
```

#### 订单模块

##### 创建工单【11.7】
- 接口：POST /api/orders
- 请求参数：
```json
{
  "service_type_id": "服务类型ID（必填，整数）",
  "title": "工单标题（必填，2-100字符）",
  "description": "工单描述（可选，最多1000字符）",
  "images": ["图片URL数组（可选）"],
  "contact_name": "联系人姓名（必填，2-50字符）",
  "contact_phone": "联系人电话（必填，11位中国大陆手机号）",
  "service_address": "服务地址（必填，5-200字符）",
  "latitude": "纬度（必填，-90到90之间）",
  "longitude": "经度（必填，-180到180之间）",
  "expected_time": "期望服务时间（可选，ISO8601格式）",
  "budget_min": "最低预算（可选，>=0）",
  "budget_max": "最高预算（可选，>=0）"
}
```
- 返回参数：
```json
{
  "code": 200,
  "message": "工单创建成功",
  "data": {
    "id": "工单ID",
    "order_no": "工单编号"
  }
}
```

##### 获取工单列表【11.7】
- 接口：GET /api/orders
- 请求参数：
```json
{
  "page": "页码（可选，默认1）",
  "limit": "每页数量（可选，默认20）",
  "status": "工单状态（可选，pending_payment、pending、accepted、pending_repair_payment、in_progress、pending_review、completed、cancelled、cancel_pending、closed）",
  "service_type_id": "服务类型ID（可选）",
  "search": "搜索关键词（可选，最多100字符）",
  "latitude": "纬度（可选）",
  "longitude": "经度（可选）",
  "distance": "距离（可选，默认1000，单位米）",
  "my_orders": "是否只看我的工单（可选，布尔值，默认false）"
}
```
- 返回参数：
```json
{
  "code": 200,
  "message": "获取工单列表成功",
  "data": {
    "total": "总数",
    "page": "当前页码",
    "limit": "每页数量",
    "pages": "总页数",
    "list": [
      {
        "id": "工单ID",
        "title": "工单标题",
        "status": "工单状态",
        "service_address": "服务地址",
        "service_type": {
          "id": "服务类型ID",
          "name": "服务类型名称"
        },
        "images": ["图片URL数组"],
        "user": {
          "id": "用户ID",
          "nickname": "用户昵称",
          "avatar": "用户头像"
        },
        "electrician": {
          "id": "电工ID",
          "name": "电工姓名",
          "avatar": "电工头像",
          "phone": "电工电话"
        },
        "amount": "订单金额",
        "needs_confirmation": "是否需要用户确认",
        "has_paid_repair": "是否已支付维修费（布尔值）",
        "repair_paid_at": "维修费支付时间（如有）",
        "cancel_reason": "取消原因（如有）"
      }
    ]
  }
}
```

##### 获取工单详情【11.7】
- 接口：GET /api/orders/:id
- 请求参数：无（通过URL参数传递ID）
- 返回参数：
```json
{
  "code": 200,
  "message": "获取工单详情成功",
  "data": {
    "id": "工单ID",
    "title": "工单标题",
    "description": "工单描述",
    "status": "工单状态",
    "created_at": "创建时间",
    "expected_time": "期望服务时间",
    "service_address": "服务地址",
    "latitude": "纬度",
    "longitude": "经度",
    "contact_name": "联系人",
    "contact_phone": "联系电话",
    "service_type": {
      "id": "服务类型ID",
      "name": "服务类型名称"
    },
    "images": ["图片URL数组"],
    "user": {
      "id": "用户ID",
      "nickname": "用户昵称",
      "avatar": "用户头像"
    },
    "electrician": {
      "id": "电工ID",
      "name": "电工姓名",
      "avatar": "电工头像",
      "phone": "电工电话"
    },
    "amount": "订单金额",
    "has_paid_repair": "是否已支付维修费（布尔值）",
    "repair_paid_at": "维修费支付时间（如有）",
    "needs_confirmation": "是否需要用户确认",
    "cancel_initiated": "是否有取消请求",
    "cancel_initiator": "取消发起方角色",
    "cancel_reason": "取消原因"
  }
}
```

##### 电工接单【11.7】
- 接口：POST /api/orders/:id/take
- 请求参数：无（通过URL参数传递ID）
- 返回参数：
```json
{
  "code": 200,
  "message": "接单成功，请核实服务地址"
}
```

##### 电工修改订单内容和金额【11.7】
- 接口：PUT /api/orders/:id/update
- 请求参数：
```json
{
  "title": "工单标题（可选，2-100字符）",
  "description": "工单描述（可选，最多1000字符）",
  "amount": "订单金额（必填，数字，不能小于0）",
  "remark": "备注（可选，最多500字符）"
}
```
- 返回参数：
```json
{
  "code": 200,
  "message": "维修金额已确认，等待用户支付",
  "data": {
    "order_id": "工单ID"
  }
}
```

##### 用户确认订单修改【11.7】
- 接口：POST /api/orders/:id/confirm-update
- 请求参数：无（通过URL参数传递ID）
- 返回参数：
```json
{
  "code": 200,
  "message": "订单修改确认成功",
  "data": {
    "order_id": "工单ID"
  }
}
```

##### 用户确认工单【11.7】待确认是否还需要这个接口
- 接口：PUT /api/orders/:id/confirm
- 请求参数：无（通过URL参数传递ID）
- 返回参数：
```json
{
  "code": 200,
  "message": "工单确认成功",
  "data": {
    "order_id": "工单ID"
  }
}
```

##### 开始维修【11.8】
- 接口：PUT /api/orders/:id/start
- 前置条件：
  - 当前用户为电工，且为该订单的指派电工
  - 订单状态为 `pending_repair_payment`
  - 已存在并成功支付维修费（`has_paid_repair = true`）
- 请求参数：
```json
{
  "remark": "备注（可选，最多500字符）"
}
```
- 返回参数：
```json
{
  "code": 200,
  "message": "已开始维修"
}
```
- 幂等与并发：
  - 多次调用不重复更改状态
  - 并发调用通过条件更新进行保护

##### 完成服务【11.7】
- 接口：POST /api/orders/:id/complete
- 请求参数：
```json
{
  "repair_content": "维修内容（可选，至少5个字符，最多1000字符）",
  "repair_images": ["维修图片URL数组（可选，最多9张）"]
}
```
- 兼容参数：
```json
{
  "completion_note": "完成说明（可选，至少5个字符，最多1000字符）",
  "completion_images": ["完成图片URL数组（可选，最多9张）"]
}
```
- 返回参数：
```json
{
  "code": 200,
  "message": "服务已完成，订单进入待评价"
}
```

##### 用户评价订单【11.8】
- 接口：PUT /api/orders/:id/review
- 前置条件：
  - 当前用户为工单创建用户（`current_role = user`，且 `order.user_id = 当前用户ID`）
  - 订单状态为 `pending_review`
- 请求参数：
```json
{
  "rating": "评分（必填，整数，1-5）",
  "comment": "评价内容（可选，最多1000字符）"
}
```
- 返回参数：
```json
{
  "code": 200,
  "message": "评价成功，订单已完成",
  "data": {
    "order_id": "工单ID"
  }
}
```

##### 发起取消订单请求【11.7】
- 接口：POST /api/orders/:id/initiate-cancel
- 说明：用户可以取消待接单、已接单和进行中状态的订单，电工可以取消已接单和进行中状态的订单。用户取消待接单状态的订单会直接取消，已接单和进行中状态的订单无论是用户还是电工发起取消，都需要对方确认。
- 请求参数：
```json
{
  "reason": "取消原因（必填，最多500字符）"
}
```
- 返回参数（已接单/进行中状态发起取消）：
```json
{
  "code": 200,
  "message": "取消订单请求已发起，等待对方确认",
  "data": {
    "order_id": "工单ID"
  }
}
```
- 返回参数（用户取消待接单状态）：
```json
{
  "code": 200,
  "message": "订单已取消",
  "data": {
    "order_id": "工单ID"
  }
}
```

##### 确认取消订单【取消订单不需要确认了应该11.7】
- 接口：POST /api/orders/:id/confirm-cancel
- 请求参数：
```json
{
  "cancel_reason": "取消原因（必填，最多500字符）"
}
```
- 返回参数：
```json
{
  "code": 200,
  "message": "订单已成功取消",
  "data": {
    "order_id": "工单ID"
  }
}
```

##### 获取工单统计【11.7】
- 接口：GET /api/orders/stats/summary
- 请求参数：
```json
{
  "start_date": "开始日期（可选，YYYY-MM-DD格式）",
  "end_date": "结束日期（可选，YYYY-MM-DD格式）"
}
```
- 返回参数：
```json
{
  "code": 200,
  "message": "获取工单统计成功",
  "data": {
    "total": "总工单数",
    "pending_payment": "待支付预付款数",
    "pending": "待接单数",
    "accepted": "已接单数",
    "pending_repair_payment": "待支付维修费数",
    "in_progress": "进行中数",
    "completed": "已完成数",
    "cancelled": "已取消数"
  }
}
```